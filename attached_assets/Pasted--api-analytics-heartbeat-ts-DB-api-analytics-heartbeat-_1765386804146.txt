[ìš”ì²­] /api/analytics/heartbeat.ts DB ì—ëŸ¬ ìˆ˜ì • (ì™„ì „ êµì²´)

í˜„ì¬ /api/analytics/heartbeat ê°€ 500 ì—ëŸ¬(db_error)ë¥¼ ë°˜í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ì›ì¸ ì¶”ì ì´ ê¸¸ì–´ì ¸ì„œ, heartbeat.tsë¥¼ ì•„ë˜ ì½”ë“œë¡œ í†µì§¸ë¡œ êµì²´í•´ ì£¼ì„¸ìš”.

ì´ ë²„ì „ì€:

supabaseAdmin(service role) ì¬ì‚¬ìš©

analytics_sessions í…Œì´ë¸”ì— upsert (sid ê¸°ì¤€) ë§Œ ìˆ˜í–‰

í•„ë“œëŠ” ìµœì†Œí•œë§Œ ì‚¬ìš©: sid, path_last, last_seen, user_agent, ip_hash

ì¤‘ë³µ sidì—¬ë„ ì—ëŸ¬ ì—†ì´ ë®ì–´ì“°ê¸°

// src/pages/api/analytics/heartbeat.ts
import type { NextApiRequest, NextApiResponse } from "next";
import { supabaseAdmin } from "@/lib/supabaseAdmin"; // ê¸°ì¡´ admin APIì—ì„œ ì“°ëŠ” í´ë¼ì´ì–¸íŠ¸
import crypto from "crypto";

const COOKIE_NAME = "kimpai_sid";

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== "POST") {
    return res.status(405).json({ ok: false, error: "method_not_allowed" });
  }

  try {
    const { path } = (req.body || {}) as { path?: string };

    // 1) sid ì¿ í‚¤ ê°€ì ¸ì˜¤ê¸° / ì—†ìœ¼ë©´ ìƒì„±
    let sid = req.cookies[COOKIE_NAME];
    let needSetCookie = false;

    if (!sid) {
      sid = Math.random().toString(36).slice(2);
      needSetCookie = true;
    }

    // 2) IP í•´ì‹œ, UA
    const xfwd = (req.headers["x-forwarded-for"] as string) || "";
    const ip = xfwd.split(",")[0].trim() || "";
    const ipHash = ip
      ? crypto.createHash("sha256").update(ip).digest("hex")
      : null;

    const userAgent = (req.headers["user-agent"] as string) || null;
    const now = new Date().toISOString();

    // 3) ìµœì†Œ í•„ë“œë§Œ upsert (sid ê¸°ì¤€)
    const { error } = await supabaseAdmin
      .from("analytics_sessions")
      .upsert(
        {
          sid,
          path_last: path || null,
          last_seen: now,
          user_agent: userAgent,
          ip_hash: ipHash,
        },
        { onConflict: "sid" }
      );

    if (error) {
      console.error("[analytics] heartbeat upsert error", {
        message: error.message,
        details: error.details,
        hint: error.hint,
      });
      return res.status(500).json({
        ok: false,
        error: "db_error",
        message: error.message,
        details: error.details,
        hint: error.hint,
      });
    }

    // 4) ìƒˆ sidë©´ ì¿ í‚¤ ì„¸íŒ…
    if (needSetCookie) {
      res.setHeader(
        "Set-Cookie",
        `${COOKIE_NAME}=${sid}; Path=/; HttpOnly; SameSite=Lax`
      );
    }

    return res.status(200).json({ ok: true });
  } catch (e: any) {
    console.error("[analytics] heartbeat handler error", e);
    return res.status(500).json({ ok: false, error: "server_error" });
  }
}


ğŸ”¹ analytics_sessions í˜„ì¬ ìŠ¤í‚¤ë§ˆ:

sid (text, unique)

path_last (text, nullable)

last_seen (timestamptz)

created_at (timestamptz, default now())

user_agent (text, nullable)

ip_hash (text, nullable)

device / os / browser ì»¬ëŸ¼ì€ ìˆì–´ë„ ë˜ê³ , ì‚¬ìš©ì€ ì•ˆ í•´ë„ ë©ë‹ˆë‹¤.

ìˆ˜ì • í›„ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤

Dev ì„œë²„ ì¬ì‹œì‘

í”„ë¦¬ë·° ë„ë©”ì¸ì—ì„œ íƒ­ ë‘ ê°œ:

íƒ­1: /

íƒ­2: /admin â†’ â€œì‹¤ì‹œê°„ ì ‘ì†â€ íƒ­

Network:

/api/analytics/heartbeat â†’ 200 ìœ¼ë¡œ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ”ì§€

Supabase SQL:

select sid, path_last, last_seen
from public.analytics_sessions
order by last_seen desc
limit 10;


ì—¬ê¸°ì„œ rowê°€ ê³„ì† ëŠ˜ì–´ë‚˜ë©´ OKì…ë‹ˆë‹¤.
ê·¸ ìƒíƒœì—ì„œ /admin ì‹¤ì‹œê°„ ì ‘ì†ì ì¹´ë“œì— ìˆ«ì/ë¦¬ìŠ¤íŠ¸ê°€ ëœ¨ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.