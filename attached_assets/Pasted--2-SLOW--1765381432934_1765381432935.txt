🧾 [전달문] 코인테이블 스크롤 튐/접힘 2차 개선
🎯 현재 증상

코인테이블을 아래로 쭉 내리고 있다가

SLOW 폴링 타이밍에

테이블이 잠깐 위로 올라간 느낌으로 “접혔다가”

다시 아까 마지막 보던 위치 근처로 튀어 돌아오는 현상

🚨 원인 추정

PremiumTable / rows가 리마운트되거나, 길이가 크게 변함

동적 key 사용

조건부 렌더링으로 컴포넌트가 아예 교체됨

브라우저의 자동 스크롤 복원(history.scrollRestoration = "auto")과
DOM 높이 변화가 겹치면서
→ 스크롤이 위/아래로 튀는 현상

✅ 수정 목표

PremiumTable 컴포넌트와 테이블 DOM은 절대 언마운트되지 않게 유지

rows는 마지막 정상 데이터를 계속 들고 있고,
재검증 도중에라도 길이가 0/급변하지 않게 유지

브라우저의 자동 스크롤 복원 기능 비활성화

1. PremiumTable / 부모에서 동적 key 제거
❌ 다음과 같은 패턴 전부 제거
// 이런 식의 key는 전부 제거
<PremiumTable
  key={domestic + foreign + filterMode}    // 필터 바뀔 때만 필요
  domestic={domestic}
  foreign={foreign}
/>

<PremiumTable key={rows.length} ... />

<table key={rows.length}>


프론트 폴링(SLOW/FAST) 때문에 rows.length가 바뀌면
→ React가 PremiumTable/테이블 전체를 다시 마운트
→ 스크롤/상태 전부 초기화
→ 브라우저가 이전 위치 복원하면서 튐

✅ PremiumTable은 key 없이, 한 번만 마운트되게 유지

진짜로 바뀌어야 할 때(예: domestic/foreign 바뀔 때)만 페이지 단위로 리셋.

2. useMarketsWithFastMode에서 rows를 안정적으로 유지

재검증 타이밍에 SLOW 데이터가 잠깐 비거나 이상해지더라도,
항상 “마지막 정상 rows”를 보여주도록 보강.

// useMarketsWithFastMode.ts

import { useRef, useMemo } from "react";

export function useMarketsWithFastMode(...) {
  // 기존 slowData / fastData 가져오는 로직 유지
  const { data: slowData, error: slowError } = useSWR(...);
  const { data: fastData } = useSWR(...);

  const baseRows = slowData?.rows ?? [];

  const fastMap = new Map(
    (fastData?.rows ?? []).map((row: any) => [row.symbol, row])
  );

  const mergedRows = baseRows.map((row: any) => {
    const fastRow = fastMap.get(row.symbol);
    return fastRow ?? row;
  });

  // 🔥 핵심: 마지막 정상 rows를 기억하는 ref
  const lastStableRowsRef = useRef<any[]>([]);

  const stableRows = useMemo(() => {
    if (mergedRows && mergedRows.length > 0) {
      lastStableRowsRef.current = mergedRows;
      return mergedRows;
    }
    // 만약 mergedRows가 빈 배열/undefined라면
    // → 직전 정상 rows를 그대로 사용
    return lastStableRowsRef.current;
  }, [mergedRows]);

  const isInitialLoading = !slowData && !slowError;

  return {
    rows: stableRows,
    isInitialLoading,
    // isSlowValidating 등 기존 리턴값 유지
  };
}


👉 이렇게 하면:

폴링/재검증 도중에 API 응답이 잠깐 비거나 이상해져도
테이블에 보여주는 rows는 “마지막 정상 상태” 그대로 유지

DOM 높이가 갑자기 줄었다 늘어나는 상황이 많이 줄어들어서
스크롤 튐/접힘이 완화됨

3. PremiumTable 페이지에서 브라우저 스크롤 자동 복원 끄기

페이지 컴포넌트(예: pages/index.tsx 또는 코인테이블 있는 페이지)에서:

import { useEffect } from "react";

function HomePage() {
  useEffect(() => {
    if (typeof window !== "undefined" && "scrollRestoration" in window.history) {
      const prev = window.history.scrollRestoration;
      window.history.scrollRestoration = "manual";
      return () => {
        window.history.scrollRestoration = prev;
      };
    }
  }, []);

  return (
    <Layout>
      {/* ... */}
      <PremiumTable ... />
    </Layout>
  );
}

export default HomePage;


history.scrollRestoration = "manual"
→ 브라우저가 DOM 변화에 맞춰
이전 스크롤 위치를 억지로 복원하려는 시도를 막음

특히 긴 리스트 레이아웃에서
폴링/리렌더 시 위/아래로 튀는 현상 완화

4. 조건부 렌더링 점검 (테이블이 사라지는 경우 방지)

아래처럼 “조건에 따라 테이블 전체를 통으로 바꿔버리는” 패턴이 없는지 확인:

// ❌ 이런 패턴은 금지
{rows.length === 0 ? (
  <EmptyState />
) : (
  <PremiumTable ... />
)}


→ rows가 0인 순간 테이블 삭제 → DOM 확 줄어듦 → 스크롤 튐.

✅ 대신:

<PremiumTable ... />
{rows.length === 0 && (
  <div className="mt-2 text-sm text-slate-500">
    조건에 맞는 코인이 없습니다.
  </div>
)}


테이블 컴포넌트 자체는 항상 유지

상태메시지만 별도 렌더

🎉 최종 기대 효과

스크롤을 아래로 많이 내린 상태에서도

SLOW(6초) 폴링

FAST(1초) 반영
어느 타이밍에도 테이블이 접히거나, 위로 튀어올랐다가 다시 내려오는 현상 없음

PremiumTable / rows / DOM 구조 최대한 안정화

브라우저 자동 스크롤 복원 비활성화로 튐 현상 추가 완화