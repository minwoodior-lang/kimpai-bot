[요청] Supabase DNS 에러 계속 발생 – 실제 사용 중인 URL 로깅 & 수정

현재 /api/analytics/heartbeat 응답 JSON이 다음과 같습니다:

{
  "ok": false,
  "error": "db_error",
  "message": "TypeError: fetch failed",
  "details": "TypeError: fetch failed\n\nCaused by: Error: getaddrinfo ENOTFOUND nrkupjbrinvpstdwdpor.supabase.co (ENOTFOUND)\nError: getaddrinfo ENOTFOUND nrkupjbrinvpstdwdpor.supabase.co ..."
}


이 말은 곧,

Supabase 클라이언트가 아직도
nrkupjbrinvpstdwdpor.supabase.co 라는 가짜 URL로 초기화되고 있다는 뜻입니다.

즉, DNS 에러는 아직 해결되지 않았습니다.

heartbeat.ts / analytics-summary.ts 에서 사용하는 Supabase URL/키가
실제 Secrets에 있는 값이 아니라,
어딘가에 남아있는 잘못된 값(또는 .env)의 값을 읽고 있는 상태입니다.

1️⃣ 실제로 어떤 URL을 쓰는지 로그로 먼저 찍어주세요

src/pages/api/analytics/heartbeat.ts 맨 위쪽에,
Supabase 클라이언트 만들기 직전에 아래 로그를 추가해 주세요:

console.log("[heartbeat] env SUPABASE_URL =", process.env.SUPABASE_URL);
console.log("[heartbeat] env NEXT_PUBLIC_SUPABASE_URL =", process.env.NEXT_PUBLIC_SUPABASE_URL);
console.log("[heartbeat] env SUPABASE_SERVICE_ROLE_KEY startsWith =", process.env.SUPABASE_SERVICE_ROLE_KEY?.slice(0, 20));


그리고 실제로 Supabase 클라이언트 초기화하는 부분도 꼭 보여주세요. 예:

// 현재 코드가 어떻게 되어 있는지 확인 필요
const supabase = createClient(
  process.env.SUPABASE_URL ?? process.env.NEXT_PUBLIC_SUPABASE_URL ?? "",
  process.env.SUPABASE_SERVICE_ROLE_KEY ?? ""
);


Dev 서버 실행 후 /api/analytics/heartbeat 한 번 호출해서
Replit 콘솔 로그에 찍힌 값이 어떤지 확인해 주세요.

기대하는 정상 값 예시:

[heartbeat] env SUPABASE_URL = https://xxxxx.supabase.co
[heartbeat] env NEXT_PUBLIC_SUPABASE_URL = https://xxxxx.supabase.co
[heartbeat] env SUPABASE_SERVICE_ROLE_KEY startsWith = eyJhbGciOiJIUzI1NiIsInR5c...


지금은 거의 100%:

[heartbeat] env SUPABASE_URL = https://nrkupjbrinvpstdwdpor.supabase.co


이런 식 또는 아예 undefined로 찍히고 있을 가능성이 큽니다.

2️⃣ Supabase URL/Key 설정을 아래처럼 통일해 주세요

1) Replit Secrets 기준

Replit Secrets에 다음 값이 정확히 들어있는지 확인해 주세요:

SUPABASE_URL → https://xxxxx.supabase.co (Supabase 프로젝트 URL)

SUPABASE_SERVICE_ROLE_KEY → service_role 키 (API 페이지에서 복사한 값)

NEXT_PUBLIC_SUPABASE_URL 은 필요 없으면 빼도 됩니다.
(클라이언트용 anon 키 쓸 때만 필요)

2) .env 파일에 있는 잘못된 값 제거

.env 파일에 아래 키가 있다면 모두 삭제하거나 주석 처리해 주세요:

SUPABASE_URL=https://nrkupjbrinvpstdwdpor.supabase.co
NEXT_PUBLIC_SUPABASE_URL=https://nrkupjbrinvpstdwdpor.supabase.co


Replit에서는 Secrets가 우선이 아니라,
오히려 .env가 잘못된 값을 계속 덮어쓰고 있을 수 있습니다.
→ .env 쪽 잘못된 Supabase URL을 반드시 제거해야 합니다.

3️⃣ Supabase 클라이언트 초기화 코드 통일

heartbeat.ts, analytics-summary.ts 에서 Supabase를 다음처럼 초기화해 주세요:

import { createClient } from "@supabase/supabase-js";

const supabaseUrl = process.env.SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error("[supabase] missing env", {
    supabaseUrl,
    supabaseServiceKeyExists: !!supabaseServiceKey,
  });
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);


여기서 하드코딩된 URL(nrkupjbrinvpstdwdpor...)이 들어간 부분이 단 1줄이라도 있으면 안 됩니다.

혹시라도 || "https://nrkupjbrinvpstdwdpor.supabase.co" 같은
fallback 코드가 들어가 있다면 전부 제거해 주세요.

4️⃣ 수정 후 확인 절차

Dev 서버 완전 재시작 (Stop → Run)

브라우저에서 /api/analytics/heartbeat 직접 열기

JSON 응답이 {"ok":true} 또는 최소한 db_error 없이 200이어야 합니다.

Replit 콘솔에서 방금 추가한 로그 확인:

[heartbeat] env SUPABASE_URL = https://xxxxx.supabase.co 로 찍히는지

Supabase SQL에서:

select sid, path_last, last_seen
from public.analytics_sessions
order by last_seen desc
limit 10;


→ 새로운 row가 생기고, last_seen 시간이 계속 업데이트되는지 확인

/admin → “실시간 접속” 탭에서

"지금 접속 중" 숫자 > 0

"오늘 방문자" > 0

테이블에 접속자 리스트 표시되는지 확인