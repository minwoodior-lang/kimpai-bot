📮 Replit 전달문 – “지금 로직 전부 꼬였으니 싹 밀고, 국내 거래소 원본으로 다시 가져오기”
🚨 상황 요약

현재 exchange_markets / 메타데이터 로직이
여러 번 수정/머지되면서 중복 코인도 많고, 잘못된 매핑이 섞인 상태입니다.
이 상태에서 땜질하면 더 꼬이니,
한 번 싹 밀고, “국내 거래소 원본” 기준으로 다시 세팅해야 합니다.

1️⃣ 먼저 DB 데이터 싹 비우기

Supabase 콘솔(SQL 탭)에서 아래 순서로 실행해 주세요.

-- 1) 프리미엄 계산 베이스가 되는 마켓 정보 전체 삭제
DELETE FROM exchange_markets;

-- 2) (선택) 국내 자동화 메타데이터만 썼던 master_symbols 정리 필요하면
--    전체 초기화하거나, 국내용만 정리
--    필요시:
-- DELETE FROM master_symbols;


핵심:
지금 꼬여 있는 모든 마켓/메타데이터를 다 날리고,
순수하게 “국내 거래소 → Supabase” 단방향으로만 다시 채웁니다.

2️⃣ 새 기준: “국내 거래소 원본만이 Single Source of Truth”
✅ 기준 거래소 & 마켓

업비트: KRW / BTC / USDT 마켓

빗썸: KRW / BTC / USDT 마켓

코인원: KRW 마켓

이 네트워크에 상장된 코인만 가져오면 됩니다.
해외 전체 마켓은 절대 기준이 아니고, 참조도 나중에만 씁니다.

3️⃣ 새로 만들 sync 스크립트 3개 (기존 꼬인 로직 전부 무시)

각 거래소별로 딱 하나씩 워커를 만들고,
이 워커만이 exchange_markets에 데이터를 넣도록 해 주세요.

(1) scripts/syncUpbitMarkets.ts
import "dotenv/config";
import fetch from "node-fetch";
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  { auth: { persistSession: false } }
);

async function syncUpbit() {
  const res = await fetch(
    "https://api.upbit.com/v1/market/all?isDetails=true"
  );
  const data = await res.json();

  const rows = data
    .filter((m: any) => {
      const [quote] = m.market.split("-");
      return ["KRW", "BTC", "USDT"].includes(quote);
    })
    .map((m: any) => {
      const [quote, base] = m.market.split("-");
      return {
        exchange: "UPBIT",
        market: m.market,          // "KRW-BTC"
        base_symbol: base,         // "BTC"
        quote_symbol: quote,       // "KRW"
        name_ko: m.korean_name,    // 업비트 한글명 그대로
        name_en: m.english_name,   // 업비트 영문명 그대로
        icon_url: null,            // 아이콘은 추후 symbolIcons.json 또는 업비트 아이콘 매핑
      };
    });

  const { error } = await supabase
    .from("exchange_markets")
    .upsert(rows, { onConflict: "exchange,market" });

  if (error) {
    console.error("syncUpbit error", error);
    throw error;
  }
}

syncUpbit();


여기서 중요한 점:

어떤 머지도 하지 말고, Upbit에서 받은 값 그대로 저장

중복 방지는 onConflict: "exchange,market" 하나로 해결

이 스크립트 외에 Upbit 관련 insert 로직은 전부 제거

(2) scripts/syncBithumbMarkets.ts

빗썸도 똑같이, 거래소가 제공하는 마켓 + 메타데이터 그대로 넣어주세요.
(이미 syncBithumbNames.ts에서 심볼 리스트는 쓰고 있으니, 그걸 확장하는 형태로)

async function syncBithumb() {
  // 빗썸 마켓 리스트 + 코인 메타 정보 가져오는 공식 API 사용
  // (실제 엔드포인트는 기존에 사용하던 것 그대로)
  const markets = await fetchBithumbMarkets(); // KRW/BTC/USDT 마켓 전체
  const meta = await fetchBithumbCoinMeta();   // 심볼별 한글/영문/아이콘

  const rows = markets.map((m) => {
    const info = meta[m.baseCurrency] || {};
    return {
      exchange: "BITHUMB",
      market: `${m.quoteCurrency}-${m.baseCurrency}`,
      base_symbol: m.baseCurrency,
      quote_symbol: m.quoteCurrency,
      name_ko: info.name_ko ?? null,   // 빗썸 UI에 쓰는 한글명
      name_en: info.name_en ?? null,   // 빗썸 UI에 쓰는 영문명
      icon_url: info.icon_url ?? null, // 빗썸 아이콘
    };
  });

  const { error } = await supabase
    .from("exchange_markets")
    .upsert(rows, { onConflict: "exchange,market" });

  if (error) throw error;
}


중요:

“상장 공지 크롤링해서 이름 뽑기” 이런 거 이제 전부 금지

빗썸이 실제 마켓/앱/웹에서 쓰는 값 그대로만 신뢰

(3) scripts/syncCoinoneMarkets.ts

코인원도 마찬가지.

async function syncCoinone() {
  const markets = await fetchCoinoneMarkets(); // KRW 마켓 전체
  const meta = await fetchCoinoneCoinMeta();   // 코인원에서 사용하는 메타 (한글/영문/아이콘)

  const rows = markets.map((m) => {
    const info = meta[m.baseAsset] || {};
    return {
      exchange: "COINONE",
      market: `KRW-${m.baseAsset}`,
      base_symbol: m.baseAsset,
      quote_symbol: "KRW",
      name_ko: info.name_ko ?? null,
      name_en: info.name_en ?? null,
      icon_url: info.icon_url ?? null,
    };
  });

  const { error } = await supabase
    .from("exchange_markets")
    .upsert(rows, { onConflict: "exchange,market" });

  if (error) throw error;
}


코인원도 문자열 파싱("앰프/AMP") 하지 말고,
코인원이 API/메타에서 주는 정식 이름 그대로만 쓰기.

4️⃣ 기존에 꼬이게 만든 로직들 전부 비활성화

다음 계열 로직은 더 이상 사용하면 안 됩니다.

mergeExchangeMetadata.ts

refreshExchangeMarkets.ts

공지 크롤링 기반으로 name_ko/name_en 덮어쓰는 워커

심볼 기준 groupBy 해서 합치는 로직

이 코드는 전부 꼬임의 원인이었고,
이제는 “거래소 원본 메타데이터”가 단일 진실이기 때문에
완전히 비활성화해야 합니다.

5️⃣ 최종 상태 (우리가 원하는 그림)

exchange_markets

행(row) 수 = “국내 거래소에서 실제 거래 중인 마켓 개수”

UPBIT KRW/BTC/USDT

BITHUMB KRW/BTC/USDT

COINONE KRW

각 행은 exchange + market으로 유니크

name_ko / name_en / icon_url은 전부 각 거래소 UI와 1:1로 동일

여기서부터 프리미엄 / 프론트는 이 테이블만 보고 쓰면 됨.
더 이상 notice, 합치기, 파싱 같은 로직은 필요 없음.