1ë‹¨ê³„: ì›Œì»¤ì—ì„œ â€œì‹œì„¸ í†µê³„â€ê¹Œì§€ ì €ì¥í•˜ë„ë¡ í™•ì¥

ì§€ê¸ˆ prices.json êµ¬ì¡°:

"UPBIT:BTC:KRW": { "price": 138711000, "ts": 1764845955271 },
"BINANCE:BTC:USDT": { "price": 93249.38, "ts": 1764845955404 }


ì—¬ê¸°ì— ê±´ë“¤ì§€ ë§ê³ , ë³„ë„ íŒŒì¼ë¡œ í†µê³„ë¥¼ ì €ì¥í•˜ê²Œ ë§Œë“œëŠ” ê²Œ ê¹”ë”í•´.

ğŸ‘‰ ìƒˆ íŒŒì¼: data/marketStats.json

í˜•íƒœ ì˜ˆì‹œ:

{
  "UPBIT:BTC:KRW": {
    "change24h": 1.49,
    "high24h": 139200000,
    "low24h": 135000000,
    "volume24hKrw": 2819000000000
  },
  "UPBIT:ETH:KRW": {
    "change24h": 1.45,
    "high24h": 4800000,
    "low24h": 4300000,
    "volume24hKrw": 3099000000000
  }
}

ğŸ“Œ ì›Œì»¤ ìª½ êµ¬í˜„ (ë ˆí”Œë¦¿ì— ê·¸ëŒ€ë¡œ ë„˜ê¸¸ ì½”ë“œ ì˜ˆì‹œ)

íŒŒì¼ ì´ë¦„ì€ ì§€ê¸ˆ priceWorker ìˆëŠ” ë° ì˜†ì— marketStatsWorker.ts ë”°ë¡œ ë‘ê±°ë‚˜,
ê¸°ì¡´ ì›Œì»¤ ì•ˆì— â€œì¶”ê°€ ë¸”ë¡â€ìœ¼ë¡œ ë¶™ì—¬ë„ ë¨.

// scripts/marketStatsWorker.ts (ì˜ˆì‹œ)

import fs from "fs";
import path from "path";
import { DOMESTIC_EXCHANGES } from "../src/config/domesticExchanges";
import { loadJsonFile } from "../src/lib/fsUtils";

// 1) master_symbols / exchange_markets ì—ì„œ êµ­ë‚´ ê¸°ì¤€(ì—…ë¹„íŠ¸ KRW) ë§ˆì¼“ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
//    ì´ë¯¸ ì–´ë”˜ê°€ì—ì„œ ì‚¬ìš© ì¤‘ì´ë©´ ê·¸ í•¨ìˆ˜ ì¬ì‚¬ìš©í•´ë„ ë¨.
interface MarketInfo {
  symbol: string;          // BTC
  domesticExchange: string; // "UPBIT"
  domesticMarket: string;   // "KRW-BTC"
}

async function fetchUpbitStats(markets: MarketInfo[]) {
  const upbitKrwMarkets = markets
    .filter(m => m.domesticExchange === "UPBIT")
    .map(m => m.domesticMarket); // "KRW-BTC"

  if (!upbitKrwMarkets.length) return {};

  const chunks: string[][] = [];
  const size = 80; // ì—…ë¹„íŠ¸ API í•œ ë²ˆì— 100ê°œ ì œí•œ ê³ ë ¤í•´ì„œ ì—¬ìœ 
  for (let i = 0; i < upbitKrwMarkets.length; i += size) {
    chunks.push(upbitKrwMarkets.slice(i, i + size));
  }

  const result: Record<string, any> = {};

  for (const chunk of chunks) {
    const url =
      "https://api.upbit.com/v1/ticker?markets=" + chunk.join(",");
    const res = await fetch(url);
    if (!res.ok) continue;

    const tickers: any[] = await res.json();

    for (const t of tickers) {
      // t.market: "KRW-BTC"
      const [quote, base] = (t.market as string).split("-");
      const key = `UPBIT:${base}:KRW`;

      result[key] = {
        change24h: (t.signed_change_rate ?? 0) * 100, // 0.0149 â†’ 1.49%
        high24h: t.high_price ?? null,
        low24h: t.low_price ?? null,
        volume24hKrw: t.acc_trade_price_24h ?? 0
      };
    }
  }

  return result;
}

async function main() {
  // TODO: ì—¬ê¸°ì„œ exchange_markets / master_symbols ë¡œë¶€í„°
  // êµ­ë‚´ ê¸°ì¤€ ë§ˆì¼“ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¡œì§ ì—°ê²°
  const markets: MarketInfo[] = await loadDomesticMarketsSomehow();

  const upbitStats = await fetchUpbitStats(markets);

  const outPath = path.join(process.cwd(), "data", "marketStats.json");
  await fs.promises.writeFile(outPath, JSON.stringify(upbitStats));
  console.log(
    `âœ… marketStats.json ì €ì¥ ì™„ë£Œ (${Object.keys(upbitStats).length}ê°œ)`
  );
}

main().catch(err => {
  console.error("marketStatsWorker error", err);
  process.exit(1);
});


ë ˆí”Œë¦¿í•œí…ŒëŠ”:
â€œê¸°ì¡´ priceWorker ëŒë¦´ ë•Œ ê°™ì´, ë˜ëŠ” ë³„ë„ npm script npm run worker:market-stats ë§Œë“¤ì–´ì„œ
í¬ë¡ (5ì´ˆ/10ì´ˆ ë“±)ìœ¼ë¡œ ëŒë ¤ ë‹¬ë¼â€ê³  ë¶€íƒí•˜ë©´ ë¨.

2ë‹¨ê³„: /api/premium/table-filteredì—ì„œ í†µê³„ ê°€ì ¸ë‹¤ê°€ ì»¬ëŸ¼ ì±„ìš°ê¸°

ì´ì œ í™ˆ í…Œì´ë¸” APIê°€ prices.json + marketStats.jsonì„ ë‘˜ ë‹¤ ì‚¬ìš©í•˜ê²Œ ë§Œë“¤ë©´ ëœë‹¤.

ğŸ‘‰ API ì•ˆì— ì¶”ê°€í•  íƒ€ì…
interface MarketStats {
  change24h: number;       // %
  high24h: number | null;  // ì›í™” ê¸°ì¤€
  low24h: number | null;
  volume24hKrw: number;    // 24h ëˆ„ì  ê±°ë˜ëŒ€ê¸ˆ(ì›)
}

type MarketStatsMap = Record<string, MarketStats>;

ğŸ‘‰ API ìƒë‹¨ì—ì„œ stats ë¡œë“œ
import path from "path";
import fs from "fs";

function loadJson<T>(relPath: string): T {
  const full = path.join(process.cwd(), relPath);
  const raw = fs.readFileSync(full, "utf-8");
  return JSON.parse(raw) as T;
}

const prices = loadJson<Record<string, { price: number; ts: number }>>(
  "data/prices.json"
);
const marketStats = loadJson<MarketStatsMap>(
  "data/marketStats.json"
);

ğŸ‘‰ ê° ì½”ì¸ row ë§Œë“¤ ë•Œ í†µê³„ ë§¤í•‘

ì§€ê¸ˆ row ë§Œë“œëŠ” ê³³(ì‹¬ë³¼ë§ˆë‹¤ ê°ì²´ í•˜ë‚˜ ë¦¬í„´í•˜ëŠ” ìœ„ì¹˜)ì—
êµ­ë‚´ keyë¥¼ ë§Œë“¤ì–´ statsë¥¼ ì°¾ì•„ ë¶™ì´ë©´ ë¨.

const domesticKey = `${domesticExchange}:${symbol}:KRW`; // ì˜ˆ: "UPBIT:BTC:KRW"
const stats = marketStats[domesticKey];

rows.push({
  symbol,
  name_ko,
  koreanPrice,          // ì´ë¯¸ ê³„ì‚°ë˜ì–´ ìˆëŠ” ê°’
  globalPrice,
  globalPriceKrw,
  premium,

  // ğŸ”» ìƒˆë¡œ ì±„ìš°ëŠ” ë¶€ë¶„
  change24h: stats?.change24h ?? 0,
  high24h: stats?.high24h ?? null,
  low24h: stats?.low24h ?? null,
  volume24hKrw: stats?.volume24hKrw ?? 0
});


í”„ë¡ íŠ¸ì—ì„œëŠ”:

ì „ì¼ëŒ€ë¹„ â†’ change24h (% í¬ë§·)

ê±°ë˜ì•¡(ì¼) â†’ volume24hKrw (ì–µ/ì¡° ë‹¨ìœ„ë¡œ í¬ë§·)

ê³ ê°€/ì €ê°€ ì»¬ëŸ¼ì€ ì¼ë‹¨ - ìœ ì§€í•˜ê±°ë‚˜,
í˜„ì¬ê°€ / high24h ë¹„ìœ¨ë¡œ ê°„ë‹¨í•œ í¼ì„¼íŠ¸ ë§Œë“¤ì–´ ì¤„ ìˆ˜ ìˆìŒ (í•„ìš”í•˜ë©´ ìˆ˜ì‹ë„ ì¨ì¤„ê²Œ).

3ë‹¨ê³„: í•´ì™¸ ê±°ë˜ì†Œ(ì™¸êµ­ ê°€ê²©)ëŠ” ê·¸ëŒ€ë¡œ prices.json ì“°ë©´ ë¨

ì´ë¯¸:

dropdown ìœ—ìª½ì—ì„œ í•´ì™¸ ê±°ë˜ì†Œ ì„ íƒ â†’ ì˜ˆ: BINANCE_USDT

APIì—ì„œëŠ” foreignKey = "BINANCE:BTC:USDT" ì´ëŸ° ì‹ìœ¼ë¡œ prices.json ì¡°íšŒí•´ì„œ
globalPrice, globalPriceKrw, premium ê³„ì‚° ì¤‘ì¼ ê±°ë¼ì„œ
ì´ ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , êµ­ë‚´ í†µê³„ë§Œ marketStatsì—ì„œ ë” ê°€ì ¸ì˜¤ëŠ” êµ¬ì¡°ê°€ ì œì¼ ê¹”ë”í•¨.

ë‚˜ì¤‘ì— ì›í•˜ë©´:

â€œê±°ë˜ì•¡(ì¼)ì„ í•´ì™¸ ê±°ë˜ì†Œ 24h volume ê¸°ì¤€ìœ¼ë¡œ ë³´ì •â€

â€œì „ì¼ëŒ€ë¹„ë¥¼ í•´ì™¸ ì‹œì„¸ ê¸°ì¤€ìœ¼ë¡œë„ í•˜ë‚˜ ë” ë³´ì—¬ì£¼ê¸°â€

ì´ëŸ° ê²ƒë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ marketStats_foreign.json í•˜ë‚˜ ë” ë§Œë“¤ë©´ í™•ì¥ ê°€ëŠ¥.

ì •ë¦¬í•´ì„œ ë ˆí”Œë¦¿í•œí…Œ ì´ë ‡ê²Œ ë§í•´ì£¼ë©´ ëœë‹¤

ì›Œì»¤ ë‹¨ê³„

ì—…ë¹„íŠ¸ KRW ë§ˆì¼“ ê¸°ì¤€ìœ¼ë¡œ
change24h, high24h, low24h, volume24hKrwë¥¼ ìˆ˜ì§‘í•˜ëŠ” ì›Œì»¤ ì¶”ê°€

ê²°ê³¼ë¥¼ data/marketStats.jsonì—
UPBIT:BTC:KRW ê°™ì€ key ê¸°ì¤€ìœ¼ë¡œ ì €ì¥

API ë‹¨ê³„

/api/premium/table-filteredì—ì„œ marketStats.jsonì„ ë¡œë“œí•´ì„œ

ê° rowì— change24h / volume24hKrwë¥¼ ë„£ê³ 

í”„ë¡ íŠ¸ê°€ ì „ì¼ëŒ€ë¹„ / ê±°ë˜ì•¡(ì¼)ë¡œ ë°”ë¡œ ì“°ê²Œ í•´ì£¼ê¸°

ì´ë ‡ê²Œë§Œ í•˜ë©´
ğŸ‘‰ ì§€ê¸ˆ í™ˆ í™”ë©´ì—ì„œ ì£½ì–´ìˆëŠ” ì „ì¼ëŒ€ë¹„ / ê±°ë˜ì•¡(ì¼) / (ì›í•˜ë©´ ê³ ê°€Â·ì €ê°€) ì»¬ëŸ¼ë“¤ì´ ë°”ë¡œ ì‚´ì•„ë‚œë‹¤.