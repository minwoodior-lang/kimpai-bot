[요청] Supabase DNS 오류 수정 및 heartbeat/analytics-summary 클라이언트 통합

현재 로그에 다음과 같은 에러가 발생하고 있습니다:

Error: getaddrinfo ENOTFOUND nrkupjbrinvpstdwdpor.supabase.co

= Supabase 클라이언트가 잘못된 URL로 초기화되어 DNS 에러가 나는 상태입니다.

원인:
- heartbeat / analytics-summary 쪽에서 Supabase 클라이언트를 따로 createClient(...)로 만들면서,
  .env의 잘못된 값(또는 placeholder 값 nrkupjbrinvpstdwdpor.supabase.co)을 읽고 있습니다.
- 다른 API에서 사용하는 supabase 클라이언트와 설정이 달라진 상태입니다.

아래처럼 수정 부탁드립니다.

1) 공통 supabaseAdmin 클라이언트 재사용

프로젝트 내에 이미 사용 중인 admin 클라이언트가 있을 겁니다. 예:

  - src/lib/supabaseAdmin.ts
  - 혹은 비슷한 이름의 파일에서 createClient(NEXT_PUBLIC_SUPABASE_URL, SERVICE_ROLE_KEY) 한 번만 호출하는 헬퍼

이 클라이언트를 기준으로 통일해주세요.

구체적으로:

- src/pages/api/analytics/heartbeat.ts
- src/pages/api/admin/analytics-summary.ts

이 두 파일에서

  import { createClient } from "@supabase/supabase-js";
  const supabase = createClient(process.env.SUPABASE_URL!, ...);

같이 직접 createClient(...) 하는 코드를 모두 제거하고,

  import { supabaseAdmin } from "@/lib/supabaseAdmin";

  const supabase = supabaseAdmin;

형태로 교체해주세요.

즉, heartbeat / analytics-summary는 **항상 supabaseAdmin** 만 사용하도록 통일합니다.

2) heartbeat 쪽 upsert 코드 예시 (참고용)

heartbeat.ts 안에서 DB 호출부는 다음과 같이 유지하면 됩니다:

  const { error } = await supabase
    .from("analytics_sessions")
    .upsert(
      {
        sid,
        path_last: path || null,
        last_seen: now,
        user_agent: userAgent,
        ip_hash: ipHash,
      },
      { onConflict: "sid" }
    );

environment 변수는 supabaseAdmin 내부에서 이미 처리하고 있다고 가정합니다.

3) .env 에 있는 잘못된 SUPABASE_URL 제거

현재 .env에 dummy 값(nrkupjbrinvpstdwdpor...)이 남아 있다면,
이 값 때문에 개발 환경에서 잘못된 URL이 로드될 수 있습니다.

- .env에서 SUPABASE_URL, NEXT_PUBLIC_SUPABASE_URL 등의 잘못된 값이 있다면 삭제하거나 주석 처리해주세요.
- Replit Secrets에 설정된 값만 사용하면 됩니다.

4) 수정 후 확인

- Dev 서버 재시작
- 브라우저에서 / 와 /admin(실시간 접속 탭) 열기
- Network 탭에서
    /api/analytics/heartbeat → 200
    /api/admin/analytics-summary → 200
  인지 확인
- Supabase에서:
    select sid, path_last, last_seen
    from public.analytics_sessions
    order by last_seen desc
    limit 10;
  실행했을 때 row가 증가하는지 확인
