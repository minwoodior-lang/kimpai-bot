ğŸš¨ğŸš¨ğŸš¨
ğŸ”¥ [ë ˆí”Œë¦¿ ê°œë°œìì—ê²Œ ë³´ë‚´ëŠ” ìµœì¢… í†µí•© ì „ë‹¬ë¬¸ + ì „ì²´ ì½”ë“œ í¬í•¨ë³¸]

ğŸ”§ â€œì—¬ê¸° ìˆëŠ” ì½”ë“œ ë° ì§€ì‹œì‚¬í•­ì„ ê·¸ëŒ€ë¡œ ì ìš©í•´ ì£¼ì„¸ìš”â€
ğŸš¨ Supabase ê¸°ë°˜ ê¸°ëŠ¥ì€ ëª¨ë‘ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤
ğŸš¨ ì‹œì„¸/í”„ë¦¬ë¯¸ì—„/ì‹¬ë³¼/ì•„ì´ì½˜/ë§ˆì¼“ ì •ë³´ëŠ” ì´ì œ ì „ë¶€ Replit ë¡œì»¬ JSON ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤

âœ… 1. ì´ë²ˆ êµ¬ì¡° ë³€ê²½ ì´ìœ  (ìš”ì•½)

Supabaseì—ì„œ PGRST002, READ-ONLY, Schema Cache Error ë“±ì´ ê³„ì† ë°œìƒí•´
í”„ë¦¬ë¯¸ì—„ ê³„ì‚°/ì‹œì„¸/ì‹¬ë³¼/ë§ˆì¼“ ë¡œë”© ì „ì²´ê°€ ë°˜ë³µì ìœ¼ë¡œ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ Supabase ì˜ì¡´ì„±ì„ ì™„ì „íˆ ì œê±°í•˜ê³ 
Replit ë¡œì»¬ íŒŒì¼(JSON) ê¸°ë°˜ì˜ êµ¬ì¡°ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.

ì´ì œ ì„œë¹„ìŠ¤ëŠ” Supabase ìƒíƒœì™€ ê´€ê³„ì—†ì´ ì •ìƒì‘ë™í•©ë‹ˆë‹¤.

SupabaseëŠ” ì•ìœ¼ë¡œ ì•„ë˜ ê¸°ëŠ¥ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤:

users

alerts

notice

ì‹œì„¸/í”„ë¦¬ë¯¸ì—„/ì‹¬ë³¼/ë§ˆì¼“ ê´€ë ¨ ê¸°ëŠ¥ì€ Supabaseë¥¼ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

âœ… 2. Replitì—ì„œ ì ìš©í•´ì•¼ í•  ì‹ ê·œ/êµì²´ íŒŒì¼ ì „ì²´ ëª©ë¡

ì•„ë˜ 3ê°œ íŒŒì¼ì„ í”„ë¡œì íŠ¸ì— ê·¸ëŒ€ë¡œ ë®ì–´ì“°ê¸°/ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤:

scripts/priceWorker.ts

src/pages/api/premium/table.ts

src/utils/metadataMapper.ts

ê·¸ë¦¬ê³  í•„ìš”í•œ JSON ë°ì´í„° íŒŒì¼ë“¤ì€ /data í´ë”ì— ì €ì¥ë©ë‹ˆë‹¤.

data/master_symbols.json âœ” ì¡´ì¬í•¨

data/premiumTable.json âœ” priceWorker ì‹¤í–‰ í›„ ìƒì„±ë¨

data/exchange_markets.json âœ” ìƒ˜í”Œ ìƒíƒœ â†’ ì´í›„ ì „ì²´ë¡œ ëŒ€ì²´ í•„ìš”

data/exchange_symbol_mappings.json âœ” ìƒ˜í”Œ ìƒíƒœ â†’ ì´í›„ ì „ì²´ë¡œ ëŒ€ì²´ í•„ìš”

ğŸš€ 3. ì ìš©í•´ì•¼ í•˜ëŠ” ì½”ë“œ ì „ì²´

ì•„ë˜ ì½”ë“œë¥¼ ë ˆí”Œë¦¿ì´ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤.
(ëˆ„ë½ ì—†ì´ ì „ë¶€ í¬í•¨ë¨)

ğŸ”¥ [íŒŒì¼ 1] scripts/priceWorker.ts
// scripts/priceWorker.ts
import fs from "fs";
import path from "path";
import axios from "axios";

interface ExchangeMarket {
  exchange: string;
  market_symbol: string;
  base_symbol: string;
  quote_symbol: string;
  is_active?: boolean;
}

interface PremiumRow {
  symbol: string;
  koreanPrice: number | null;
  globalPrice: number | null;
  globalPriceKrw: number | null;
  premium: number | null;
  domesticExchange: string | null;
  foreignExchange: string | null;
}

const FX_DEFAULT = 1350;

function loadExchangeMarkets(): ExchangeMarket[] {
  const filePath = path.join(process.cwd(), "data", "exchange_markets.json");
  const raw = fs.readFileSync(filePath, "utf8");
  const json = JSON.parse(raw);
  return json as ExchangeMarket[];
}

async function fetchUpbitTickers(markets: string[]) {
  if (!markets.length) return {};
  const url = `https://api.upbit.com/v1/ticker?markets=${markets.join(",")}`;
  const { data } = await axios.get(url);
  const result: Record<string, any> = {};
  for (const row of data) result[row.market] = row;
  return result;
}

async function fetchOkxTicker(instId: string) {
  const url = `https://www.okx.com/api/v5/market/ticker?instId=${instId}`;
  const { data } = await axios.get(url);
  return data?.data?.[0] || null;
}

async function main() {
  console.log("[priceWorker] start");

  const markets = loadExchangeMarkets().filter((m) => m.is_active ?? true);

  const upbitKrwMarkets = markets.filter(
    (m) => m.exchange === "UPBIT" && m.quote_symbol === "KRW"
  );

  const upbitIds = upbitKrwMarkets.map((m) => m.market_symbol);
  const upbitTickers = await fetchUpbitTickers(upbitIds);

  const okxUsdtMarkets = markets.filter(
    (m) => m.exchange === "OKX" && m.quote_symbol === "USDT"
  );

  const rows: PremiumRow[] = [];

  for (const m of upbitKrwMarkets) {
    const base = m.base_symbol.toUpperCase();
    const upbitTicker = upbitTickers[m.market_symbol];
    const koreanPrice = upbitTicker ? Number(upbitTicker.trade_price) : null;

    let globalPrice: number | null = null;
    let globalPriceKrw: number | null = null;
    const okxMarket = okxUsdtMarkets.find(
      (om) => om.base_symbol.toUpperCase() === base
    );

    if (okxMarket) {
      const ticker = await fetchOkxTicker(okxMarket.market_symbol);
      if (ticker?.last) {
        globalPrice = Number(ticker.last);
        globalPriceKrw = globalPrice * FX_DEFAULT;
      }
    }

    let premium: number | null = null;
    if (koreanPrice && globalPriceKrw) {
      premium = ((koreanPrice - globalPriceKrw) / globalPriceKrw) * 100;
    }

    rows.push({
      symbol: base,
      koreanPrice,
      globalPrice,
      globalPriceKrw,
      premium,
      domesticExchange: "UPBIT",
      foreignExchange: okxMarket ? "OKX" : null,
    });
  }

  const outPath = path.join(process.cwd(), "data", "premiumTable.json");
  fs.writeFileSync(outPath, JSON.stringify(rows, null, 2));

  console.log(`[priceWorker] done. count=${rows.length}`);
}

main().catch((err) => {
  console.error("[priceWorker] error:", err);
  process.exit(1);
});

ğŸ”¥ [íŒŒì¼ 2] src/pages/api/premium/table.ts
// pages/api/premium/table.ts
import fs from "fs";
import path from "path";
import type { NextApiRequest, NextApiResponse } from "next";
import { attachMetadata } from "@/utils/metadataMapper";

function loadPremium() {
  const file = path.join(process.cwd(), "data/premiumTable.json");
  if (!fs.existsSync(file)) return [];
  return JSON.parse(fs.readFileSync(file, "utf8"));
}

function loadMeta() {
  const file = path.join(process.cwd(), "data/master_symbols.json");
  return JSON.parse(fs.readFileSync(file, "utf8"));
}

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  try {
    const premium = loadPremium();
    const meta = loadMeta();

    const result = premium.map((row: any) => attachMetadata(row, meta));
    return res.status(200).json({ data: result });
  } catch (err) {
    console.error("[API] /premium/table error:", err);
    return res.status(500).json({ data: [] });
  }
}

ğŸ”¥ [íŒŒì¼ 3] src/utils/metadataMapper.ts
// src/utils/metadataMapper.ts
export function normalizeSymbol(symbol: string) {
  return symbol.replace(/[^A-Za-z0-9]/g, "").toUpperCase();
}

export function attachMetadata(item: any, meta: any) {
  const sym = normalizeSymbol(item.symbol);
  const m = meta[sym] || {};

  return {
    ...item,
    nameKo: m.name_ko || null,
    nameEn: m.name_en || null,
    iconUrl: m.icon_url || null,
    displayName: m.name_ko || m.name_en || sym,
  };
}

âœ… 4. Replitì—ì„œ í•´ì•¼ í•  í›„ì† ì‘ì—…
â‘  ì›Œì»¤ ì‹¤í–‰ (í•„ìˆ˜)
npx tsx scripts/priceWorker.ts

â‘¡ ì„œë²„ ì¬ì‹œì‘
â‘¢ /api/premium/table í˜¸ì¶œí•˜ì—¬ ì •ìƒ ì¶œë ¥ í™•ì¸
âš ï¸ 5. ë‚¨ì€ 1ê°œ â€” exchange_markets.json ì „ì²´ export

í˜„ì¬ exchange_markets.jsonì€ ìƒ˜í”Œ 6ê°œë§Œ ìˆìŒ.
Supabase SELECT ì˜¤ë¥˜ê°€ í’€ë¦¬ë©´ 10ì´ˆ ë§Œì— ì „ì²´ export ê°€ëŠ¥.

ì´ íŒŒì¼ë§Œ ì „ì²´ë¡œ ëŒ€ì²´ë˜ë©´
í”„ë¦¬ë¯¸ì—„ í…Œì´ë¸” ì½”ì¸ ì „ë¶€ ì •ìƒ í‘œì‹œë¨.

ğŸ”¥ ìµœì¢… ìš”ì•½

Supabase ì‹œì„¸/í”„ë¦¬ë¯¸ì—„/ì‹¬ë³¼/ë§ˆì¼“ ê¸°ëŠ¥ì€ ì™„ì „ ì œê±°ë¨

Replit ë¡œì»¬ JSON ê¸°ë°˜ìœ¼ë¡œ êµ¬ì¡° ì™„ì „ ì „í™˜ë¨

ìœ„ 3ê°œ íŒŒì¼ê³¼ 2ê°œì˜ JSONë§Œ ìˆìœ¼ë©´ ì „ì²´ ê¸°ëŠ¥ ì •ìƒ

exchange_markets.json ì „ì²´í™”ë§Œ ë‚¨ìŒ