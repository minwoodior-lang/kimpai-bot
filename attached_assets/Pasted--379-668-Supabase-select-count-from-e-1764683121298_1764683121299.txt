지금 로그상으로는

- "379개 마켓 저장됨"
- "668개 마켓 저장됨"

이런 메시지가 찍히지만, 실제 Supabase에서
select count(*) from exchange_markets;
를 해보면 0개입니다.

즉, refreshExchangeMarkets.ts에서 마켓 데이터를 수집하는 부분은 잘 동작하는데,
Supabase로 보내는 delete/insert 쿼리가 실제 DB에 전혀 반영되지 않고 있습니다.

Scheduler 구조, export 함수화는 이제 정리된 것 같고,
현재 남은 문제는 "Supabase 클라이언트로 쓰기(DELETE/INSERT)가 아예 안 되고 있다"입니다.

이 부분을 정확히 확인해 주세요.


[요청 1] refreshExchangeMarkets.ts에서 Supabase 에러를 절대로 숨기지 말고 그대로 throw 해주세요.

지금 upsertMarkets / delete+insert 부분에서

- error가 있어도 throw 하지 않거나
- data가 없어도 markets.length를 반환해서 "성공"처럼 찍는 구조가 남아있는지 확인 부탁드립니다.

예시 (개념):

async function saveMarkets(markets: ExchangeMarketRow[]): Promise<number> {
  if (markets.length === 0) return 0;

  const { error: delError } = await supabase
    .from("exchange_markets")
    .delete()
    .neq("id", 0);

  if (delError) {
    console.error("[DB Delete Error]:", delError);
    throw delError;  // ← 반드시 throw
  }

  const { data, error } = await supabase
    .from("exchange_markets")
    .insert(markets)
    .select("id");  // 실제 insert된 row 확인용

  if (error) {
    console.error("[DB Insert Error]:", error);
    throw error;    // ← 반드시 throw
  }

  console.log("[DB Insert Result] rows:", data?.length);
  return data?.length ?? 0;
}

위처럼 error가 발생하면 무조건 throw 해서
"성공 메시지 + 실제 DB 0개" 같은 상황이 다시 나오지 않게 해주세요.


[요청 2] Node 스크립트에서 사용하는 Supabase 클라이언트 설정을 한 번 더 확인해 주세요.

1) refreshExchangeMarkets.ts / marketRefreshScheduler.ts에서 사용하는 supabase 클라이언트가

- SUPABASE_URL
- SUPABASE_SERVICE_ROLE_KEY

를 사용하고 있는지,
아니면 NEXT_PUBLIC_SUPABASE_... 같은 브라우저용 anon key를 쓰고 있는지 확인 부탁드립니다.

서버 스크립트에서 anon key + RLS가 걸려 있으면
delete/insert가 막힐 수 있고,
그 경우 DB에는 아무 것도 안 들어갑니다.

2) 서버 스크립트에서 사용하는 Supabase URL/KEY가
실제 제가 보는 Supabase 프로젝트(프로덕션 DB)와 동일한지 꼭 확인해 주세요.
- 만약 다른 프로젝트/스키마를 보고 있으면
  스크립트는 "성공"했는데 제가 보는 DB에는 당연히 0개일 수 있습니다.


[요청 3] scheduler 빼고, 콘솔에서 직접 테스트해 주세요.

스케줄러/워크플로우 말고, 로컬 콘솔에서:

1) npm run refresh:markets
   를 한 번 실행한 뒤,

2) Supabase 대시보드에서 exchange_markets 테이블을 새로고침하고
   row가 실제로 생겼는지 확인해 주세요.

3) 그럼에도 0개라면, 그 순간의 delete/insert에 대해
   error 전체(JSON)와 Supabase 응답을 콘솔에 찍어서 공유 부탁드립니다.

지금 보고 있는 현상은:

- 스크립트는 "○○개 저장됨" 로그를 찍고 있고,
- Supabase DB에는 0개이며,
- API는 빈 배열을 내려보내고,
- 프론트는 그걸 받아서 에러가 나는 상황입니다.

지금 구조(함수화, 스케줄러 연결) 문제라기보다는,
"Supabase로 쓰기가 전혀 안 되고 있는데, error 처리/키 설정 때문에 그게 가려지고 있는 상태"라고 보입니다.

우선 supabase 클라이언트 설정(SERVICE ROLE KEY 사용 여부) + delete/insert 에러를 절대 숨기지 않고 throw 하는 부분부터 점검 부탁드립니다.
