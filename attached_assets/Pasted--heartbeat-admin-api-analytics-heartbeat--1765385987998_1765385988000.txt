레플릿 전달문 (그대로 복붙해서 보내면 됨)
[요청] 실시간 접속자 집계용 heartbeat를 전역으로 이동

지금 /admin에서는 /api/analytics/heartbeat 가 한 번도 호출되지 않아
analytics_sessions 테이블이 비어 있고,
그래서 실시간 접속자 수가 항상 0으로 나옵니다.

현재 heartbeat 로직이 Layout.tsx 안에만 들어 있어서
/admin 쪽 레이아웃에서는 실행이 안 되는 상태 같아요.

아래처럼 수정해서 모든 페이지(/, /admin 등) 에서 heartbeat가 돌도록 바꿔 주세요.

1️⃣ Layout.tsx에서 heartbeat 관련 useEffect 제거

fetch("/api/analytics/heartbeat" …)를 호출하는 useEffect가
src/components/Layout.tsx 에 들어있다면 전부 삭제 또는 주석 처리해 주세요.

이 로직은 _app.tsx로 옮길 예정입니다.

2️⃣ 공용 훅 생성: src/hooks/useAnalyticsHeartbeat.ts
// src/hooks/useAnalyticsHeartbeat.ts
import { useEffect } from "react";
import Router from "next/router";

export function useAnalyticsHeartbeat() {
  useEffect(() => {
    if (typeof window === "undefined") return;

    let path = window.location.pathname;

    const sendHeartbeat = () => {
      fetch("/api/analytics/heartbeat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path }),
      }).catch(() => {});
    };

    // 최초 1회
    sendHeartbeat();

    // 30초마다
    const interval = setInterval(sendHeartbeat, 30_000);

    // 라우트 변경 시 path 업데이트 + 한 번 더 전송
    const handleRouteChange = (url: string) => {
      path = url;
      sendHeartbeat();
    };
    Router.events.on("routeChangeComplete", handleRouteChange);

    return () => {
      clearInterval(interval);
      Router.events.off("routeChangeComplete", handleRouteChange);
    };
  }, []);
}

3️⃣ _app.tsx에서 훅 호출 (전역 적용)
// src/pages/_app.tsx
import type { AppProps } from "next/app";
import { useAnalyticsHeartbeat } from "@/hooks/useAnalyticsHeartbeat";
// (기존 global CSS, Provider 등 import는 그대로 유지)

export default function MyApp({ Component, pageProps }: AppProps) {
  useAnalyticsHeartbeat(); // ✅ 여기서 한 번만 호출
  return <Component {...pageProps} />;
}


이렇게 하면 모든 페이지(/, /admin, /market 등) 렌더 시
공통으로 heartbeat가 동작합니다.

4️⃣ 수정 후 확인 요청

Replit dev 서버 실행 후

외부 브라우저에서

탭1: /

탭2: /admin → “실시간 접속” 탭

Chrome DevTools Network 탭에서

/api/analytics/heartbeat 가 30초마다 찍히는지

/api/admin/analytics-summary 가 5초마다 찍히는지 확인

Supabase analytics_sessions 테이블에 row가 쌓이는지 확인

/admin “실시간 접속”에 접속자 수/리스트가 표시되는지 확인

이 상태까지 되면 실시간 접속자 집계 기능이 완전히 정상입니다.