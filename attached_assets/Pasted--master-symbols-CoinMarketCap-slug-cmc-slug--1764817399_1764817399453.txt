ğŸ“Œ ì‘ì—… ëª©í‘œ
í˜„ì¬ master_symbolsì— ë“±ë¡ëœ ì½”ì¸ë“¤ì— ëŒ€í•´,
CoinMarketCap ê°œë³„ ì½”ì¸ í˜ì´ì§€ slug(cmc_slug)ë¥¼ ìë™ìœ¼ë¡œ ìˆ˜ì§‘í•´ì„œ ì €ì¥í•˜ê³ ,
í”„ë¡ íŠ¸ì—ì„œëŠ” ì´ cmc_slugë¥¼ ì‚¬ìš©í•´ ë°”ë¡œ /currencies/{slug}/ë¡œ ì´ë™í•˜ê²Œ ì—°ê²°í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.

1ì°¨ ëª©í‘œëŠ” â€œì§€ê¸ˆ ìˆëŠ” ì½”ì¸ë“¤ ë„ë©”ì¸ë¶€í„° ì œëŒ€ë¡œ ì—°ê²°â€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
(ì´í›„ CRONìœ¼ë¡œ ëŒë ¤ì„œ ì‹ ê·œ ìƒì¥ê¹Œì§€ ìë™í™”í•  ì˜ˆì •ì…ë‹ˆë‹¤.)

============================================================
1ï¸âƒ£ Supabase master_symbols êµ¬ì¡° í™•ì¸
============================================================
í…Œì´ë¸”: master_symbols

í•„ìˆ˜ ì»¬ëŸ¼:
- id
- symbol (ì˜ˆ: BTC, ETH, LINK)
- name_en (ì˜ˆ: Bitcoin, Chainlink)
- cmc_slug (nullable, VARCHAR)

ğŸ‘‰ ë§Œì•½ cmc_slug ì»¬ëŸ¼ì´ ì—†ë‹¤ë©´:
- VARCHAR(128) ì •ë„ë¡œ cmc_slug ì»¬ëŸ¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.

============================================================
2ï¸âƒ£ CMC slug ìë™ ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
============================================================
íŒŒì¼: scripts/syncCmcSlugs.ts ë¥¼ ìƒˆë¡œ ë§Œë“¤ê³ ,
ì•„ë˜ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ë„£ì–´ì£¼ì„¸ìš”.

(ì½”ë“œ ì‹œì‘)
------------------------------------------------------------
import 'dotenv/config';
import fetch from 'node-fetch';
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = process.env.SUPABASE_URL!;
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY!;

if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
  throw new Error('Supabase í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {
  auth: { persistSession: false }
});

// ì‹¬ë³¼ â†’ ì½”ì¸ë§ˆì¼“ìº¡ slug ìˆ˜ë™ ë§¤í•‘ (ì ì  ì¶”ê°€)
const SYMBOL_SLUG_OVERRIDES: Record<string, string> = {
  BTC: 'bitcoin',
  ETH: 'ethereum',
  XRP: 'ripple',
  ADA: 'cardano',
  DOGE: 'dogecoin',
  SOL: 'solana',
  TRX: 'tron',
  AVAX: 'avalanche',
  LINK: 'chainlink',
  LTC: 'litecoin',
  BCH: 'bitcoin-cash',
  BNB: 'binance-coin',
};

function normalizeNameToSlug(name?: string | null): string | null {
  if (!name) return null;

  return name
    .toLowerCase()
    .replace(/\s*token$/g, '')
    .replace(/\s*coin$/g, '')
    .replace(/\s*\(.*?\)/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

async function testCmcSlug(slug: string): Promise<boolean> {
  const url = `https://coinmarketcap.com/ko/currencies/${slug}/`;

  try {
    const res = await fetch(url, {
      headers: {
        'User-Agent':
          'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36',
        'Accept-Language': 'ko-KR,ko;q=0.9'
      }
    });

    console.log(`[CMC TEST] slug=${slug} status=${res.status}`);
    return res.status === 200;
  } catch (err) {
    console.error('[CMC TEST ERROR]', slug, err);
    return false;
  }
}

async function delay(ms: number) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function syncCmcSlugs() {
  console.log('ğŸ”„ CMC slug ìë™ ìˆ˜ì§‘ ì‹œì‘');

  const { data: rows, error } = await supabase
    .from('master_symbols')
    .select('id, symbol, name_en, cmc_slug')
    .is('cmc_slug', null);

  if (error) {
    console.error('âŒ master_symbols ì¡°íšŒ ì˜¤ë¥˜:', error);
    return;
  }

  if (!rows || rows.length === 0) {
    console.log('âœ… ì—…ë°ì´íŠ¸í•  slug ì—†ìŒ');
    return;
  }

  console.log(`ğŸ“Œ slug ë¯¸ë“±ë¡ ì½”ì¸: ${rows.length}ê°œ`);

  for (const row of rows) {
    const { id, symbol, name_en } = row;
    const upper = symbol.toUpperCase();

    console.log(`\n==============================`);
    console.log(`ì‹¬ë³¼: ${symbol}, name_en: ${name_en}`);

    const overrideSlug = SYMBOL_SLUG_OVERRIDES[upper];
    const nameSlug = normalizeNameToSlug(name_en);
    const symbolSlug = symbol.toLowerCase();

    const candidates = [overrideSlug, nameSlug, symbolSlug].filter(Boolean) as string[];

    let finalSlug: string | null = null;

    for (const candidate of candidates) {
      const ok = await testCmcSlug(candidate);
      await delay(800); // CMCì— ë¶€ë‹´ ëœ ì£¼ê¸°

      if (ok) {
        finalSlug = candidate;
        break;
      }
    }

    if (!finalSlug) {
      console.warn(`âš ï¸ ${symbol}: ìœ íš¨í•œ slugë¥¼ ì°¾ì§€ ëª»í•´ ê±´ë„ˆëœ€`);
      continue;
    }

    console.log(`âœ… ìµœì¢… slug=${finalSlug}, DB ì—…ë°ì´íŠ¸ ì§„í–‰`);

    const { error: updateErr } = await supabase
      .from('master_symbols')
      .update({ cmc_slug: finalSlug })
      .eq('id', id);

    if (updateErr) {
      console.error(`âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, updateErr);
    } else {
      console.log(`ğŸ’¾ ì €ì¥ ì™„ë£Œ: ${symbol} â†’ ${finalSlug}`);
    }

    await delay(800);
  }

  console.log('\nğŸ‰ CMC ìŠ¬ëŸ¬ê·¸ ìë™ ìˆ˜ì§‘ ì™„ë£Œ');
}

if (require.main === module) {
  syncCmcSlugs()
    .then(() => process.exit(0))
    .catch(err => {
      console.error(err);
      process.exit(1);
    });
}
------------------------------------------------------------
(ì½”ë“œ ë)

============================================================
3ï¸âƒ£ package.jsonì— ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
============================================================
package.jsonì˜ "scripts" ì•ˆì— ë‹¤ìŒì„ ì¶”ê°€í•´ì£¼ì„¸ìš”:

"scripts": {
  ...
  "sync:cmc-slugs": "ts-node scripts/syncCmcSlugs.ts"
}

(ts-node ì‚¬ìš© ë°©ì‹ì€ í˜„ì¬ í”„ë¡œì íŠ¸ ì„¤ì •ì— ë§ê²Œ ì¡°ì •í•´ë„ ë©ë‹ˆë‹¤.)

============================================================
4ï¸âƒ£ í”„ë¡ íŠ¸ì—”ë“œ CMC ë§í¬ ì—°ê²° í™•ì¸
============================================================
ì´ë¯¸ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì•„ë‹ˆë¼ë©´ ì´ë ‡ê²Œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.

1) CoinMarketCap ìœ í‹¸
íŒŒì¼: src/lib/coinMarketCapUtils.ts

export function openCmcPage(symbol: string, cmcSlug?: string | null) {
  const base = "https://coinmarketcap.com/ko";

  const effectiveSlug =
    (cmcSlug && cmcSlug.trim()) ||
    symbol.toLowerCase(); // cmcSlug ì—†ìœ¼ë©´ ì¼ë‹¨ symbol ê¸°ë°˜

  const url = `${base}/currencies/${effectiveSlug}/?utm_source=apiswap&utm_medium=web&utm_campaign=kimpga`;

  console.log("[CMC_URL]", { symbol, cmcSlug, effectiveSlug, url });

  if (typeof window !== "undefined") {
    window.open(url, "_blank");
  }
}

2) í”„ë¦¬ë¯¸ì—„ í…Œì´ë¸”ì—ì„œ í˜¸ì¶œ ë¶€ë¶„
íŒŒì¼: src/components/PremiumTable.tsx

ì½”ì¸ëª…/ì‹¬ë³¼ í´ë¦­ ì‹œ:

onClick={() => openCmcPage(row.symbol, row.cmcSlug)}

ì¦‰, API ì‘ë‹µì— í¬í•¨ëœ row.cmcSlugë¥¼ ê·¸ëŒ€ë¡œ ë‘ ë²ˆì§¸ ì¸ìë¡œ ë„˜ê¸°ë„ë¡ ìœ ì§€í•´ì£¼ì„¸ìš”.

============================================================
5ï¸âƒ£ ì‹¤ì œ ì‹¤í–‰ ë° ë„ë©”ì¸ ì—°ê²° í™•ì¸
============================================================
1) ì½˜ì†”ì—ì„œ í•œ ë²ˆ ì‹¤í–‰:
   npm run sync:cmc-slugs

2) ì‹¤í–‰ í›„ DBì—ì„œ master_symbols.cmc_slug ê°’ì´ ì±„ì›Œì¡ŒëŠ”ì§€ í™•ì¸:
   - BTC â†’ bitcoin
   - ETH â†’ ethereum
   - LINK â†’ chainlink
   - ë“± ë©”ì´ì € ì½”ì¸ ìœ„ì£¼ë¡œ ë¨¼ì € í™•ì¸

3) ë¸Œë¼ìš°ì €ì—ì„œ:
   - í™ˆ í™”ë©´ ì½”ì¸ì…€ì—ì„œ BTC, ETH, LINK ì½”ì¸ëª… í´ë¦­
   - URLì´ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì—´ë¦¬ëŠ”ì§€ í™•ì¸:
     https://coinmarketcap.com/ko/currencies/bitcoin/...
     https://coinmarketcap.com/ko/currencies/ethereum/...
     https://coinmarketcap.com/ko/currencies/chainlink/...

ì´ë ‡ê²Œ í•˜ë©´ í˜„ì¬ ë“±ë¡ëœ ì½”ì¸ë“¤ë¶€í„° CoinMarketCap ë„ë©”ì¸ì´ ì œëŒ€ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
ì´í›„ì—ëŠ” ìƒì¥ â†’ master_symbols ìë™ ë“±ë¡ â†’ ì£¼ê¸°ì ìœ¼ë¡œ npm run sync:cmc-slugs ì‹¤í–‰ë§Œ í•´ì£¼ë©´
ìƒˆ ì½”ì¸ë“¤ë„ ìë™ìœ¼ë¡œ CMC ë„ë©”ì¸ê¹Œì§€ ì—°ê²°ë˜ëŠ” êµ¬ì¡°ê°€ ì™„ì„±ë©ë‹ˆë‹¤.
