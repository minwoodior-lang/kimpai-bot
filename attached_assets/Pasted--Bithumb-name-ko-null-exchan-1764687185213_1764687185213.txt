[추가 요청 – Bithumb name_ko 자동 채우기 (null 최소화)]

현재 상황 정리:

업비트 / 코인원: 마켓 수집/설계 이슈는 별도로 처리 중

빗썸: exchange_markets에 마켓은 878개 들어오지만,
name_ko가 여전히 대부분 null 상태입니다.

제가 원하는 최종 상태는 빗썸 마켓에 대해서는 “실제 사이트에 보이는 한글명”이 거의 전부 name_ko로 채워지는 구조입니다.

그래서 Bithumb 쪽만 추가 보완 요청 드립니다.

1) 빗썸 코인 리스트 페이지에서 “심볼 → 한글명” map 만들기

지금은 BITHUMB_NAMES 같은 매핑에 의존하고 있는데,
이걸 “빗썸 UI에 실제로 노출되는 리스트 페이지”를 HTML 크롤링해서 자동 생성되도록 바꿔 주세요.

예시 (구체 셀렉터는 실제 DOM 보고 맞춰 주세요):

import * as cheerio from "cheerio";

async function fetchBithumbNameMap(): Promise<Record<string, string>> {
  const res = await fetch("https://www.bithumb.com/trade/spot/krw");
  const html = await res.text();
  const $ = cheerio.load(html);

  const map: Record<string, string> = {};

  // 아래 셀렉터/클래스는 실제 DOM 구조 보고 맞춰 주세요.
  $("tr").each((_, el) => {
    const symbol = $(el).find(".coin_symbol").text().trim();   // 예: IMX
    const nameKo = $(el).find(".coin_name_kr").text().trim();  // 예: 이뮤터블X

    if (symbol && nameKo) {
      map[symbol] = nameKo;
    }
  });

  return map;
}


핵심은: “심볼 텍스트(IMX)”와 “한글 이름(이뮤터블X)”가 같이 있는 행을 전부 돌면서 map을 만드는 것입니다.

정확한 셀렉터/클래스명은 개발자도구로 확인해서 맞춰 주세요.

2) 기존 Bithumb 마켓 수집과 합치기

scripts/refreshExchangeMarkets.ts 안에 있는
fetchBithumbMarkets() (또는 유사 함수)를 아래처럼 바꿔 주세요:

async function fetchBithumbMarkets(): Promise<ExchangeMarketRow[]> {
  const [markets, nameMap] = await Promise.all([
    fetchBithumbMarketsRaw(), // 지금까지 쓰던 빗썸 마켓 API 호출 부분
    fetchBithumbNameMap(),    // 위에서 만든 심볼→한글명 map
  ]);

  return markets.map((m) => {
    const symbol = m.base_symbol || m.baseCurrency || m.coin; // 실제 필드명에 맞게 조정
    return {
      ...m,
      name_ko: nameMap[symbol] ?? m.name_ko ?? null,
    };
  });
}


우선순위는 이렇게 해주세요:

nameMap[symbol]: HTML에서 긁어온 실제 사이트 한글명

기존에 m.name_ko (있다면)

둘 다 없으면 null 유지

이렇게 하면, 빗썸에 실제로 상장된 대부분의 코인에서 name_ko가 자동으로 채워집니다.

3) (선택) BITHUMB_NAMES는 “마지막 보정용”으로만 남기기

만약 HTML 크롤링으로도 못 가져오는 소수의 코인이 있으면,
지금까지 만들어둔 BITHUMB_NAMES 매핑을 “마지막 fallback”으로만 써 주셔도 됩니다.

예시:

name_ko: nameMap[symbol] ?? BITHUMB_NAMES[symbol] ?? m.name_ko ?? null


이렇게 하면:

1순위: 사이트에서 긁어온 한글명

2순위: 내가 수동으로 적어둔 BITHUMB_NAMES

3순위: 기존 API에서 주는 값

그래도 없으면 null

순으로 커버가 됩니다.

4) 최종 확인 쿼리

구현 후:

npm run refresh:exchange-markets
npm run update:master-symbols


실행해 주시고, 아래 쿼리 결과를 공유해 주세요.

-- 빗썸 마켓 수
SELECT COUNT(*) 
FROM public.exchange_markets 
WHERE exchange = 'BITHUMB';

-- 빗썸 심볼 중 한글명 비율
SELECT 
  COUNT(*)                                          AS total,
  SUM((name_ko IS NULL)::int)                       AS null_ko
FROM public.master_symbols
WHERE 'BITHUMB' = ANY(exchanges);  -- 또는 exchange 목록 기준에 맞게 수정


제 목표는:

빗썸에 상장된 심볼 중 name_ko가 null인 비율이 최소화되는 것 (소수 예외만 null)

이렇게만 처리해 주시면,
업비트/코인원은 API로,
빗썸은 HTML + 보정맵 조합으로 name_ko가 거의 다 채워지는 구조가 완성됩니다.