ğŸ§¾ [ì „ë‹¬ë¬¸] KimpAI ì½”ì¸í…Œì´ë¸” FAST(30ê°œ) / SLOW(ë‚˜ë¨¸ì§€) ë°˜ì˜ êµ¬ì¡°
0. ëª©í‘œ ìš”ì•½

ë°±ì—”ë“œ ì›Œì»¤ êµ¬ì¡°, JSON íŒŒì´í”„ë¼ì¸ì€ ê±´ë“œë¦¬ì§€ ì•ŠëŠ”ë‹¤.

priceWorker, statsWorker, prices.json, premiumTable.json, marketStats.json ê¸°ì¡´ ì£¼ê¸° ê·¸ëŒ€ë¡œ ìœ ì§€ (3ì´ˆ/1ì´ˆ/í˜¼í•©).

í”„ë¡ íŠ¸ ì½”ì¸í…Œì´ë¸”ë§Œ FAST / SLOWë¡œ ë‚˜ëˆˆë‹¤.

FAST: êµ­ë‚´ KRW ê¸°ì¤€ ê±°ë˜ëŒ€ê¸ˆ ìƒìœ„ 30ê°œ ì½”ì¸

ì—…ë°ì´íŠ¸: 1ì´ˆ ê°„ê²© (REST í´ë§ / ë‚˜ì¤‘ì— WebSocket ëŒ€ì²´ ê°€ëŠ¥)

SLOW: ë‚˜ë¨¸ì§€ ì „ ì½”ì¸

ì—…ë°ì´íŠ¸: 6ì´ˆ ê°„ê²© (REST í´ë§)

í…Œì´ë¸”ì€ í•˜ë‚˜ë¡œ ë³´ì´ë˜,

ìƒë‹¨ â€œí•µì‹¬ ì½”ì¸ë“¤â€(FAST)ë§Œ ë¯¸ì¹œ ë“¯ì´ ê¿ˆí‹€,

ë‚˜ë¨¸ì§€(ì¡ì•ŒíŠ¸)ëŠ” â€œì‚´ì•„ëŠ” ìˆëŠ”ë° ì¢€ ëŠë¦¬ê²Œ ì›€ì§ì´ëŠ” ëŠë‚Œâ€ìœ¼ë¡œ ë§Œë“ ë‹¤.

1. ë°±ì—”ë“œ ë³€ê²½ â€“ /api/premium/table-filtered FAST ëª¨ë“œ ì¶”ê°€
1-1. íŒŒì¼ ìœ„ì¹˜

src/pages/api/premium/table-filtered.ts

1-2. ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì¶”ê°€

ê¸°ì¡´ íŒŒë¼ë¯¸í„°( domestic, foreign, filter ë“±)ì— ë”í•´ì„œ:

mode (optional)

mode=fast â†’ FASTìš© ì‘ë‹µ (ìƒìœ„ 30ê°œë§Œ)

ì—†ìœ¼ë©´ â†’ ê¸°ì¡´ì²˜ëŸ¼ ì „ì²´ í…Œì´ë¸” ì‘ë‹µ

// ì˜ˆì‹œ: /api/premium/table-filtered?domestic=UPBIT_KRW&foreign=BINANCE_USDT&mode=fast

1-3. marketStats ê¸°ë°˜ìœ¼ë¡œ êµ­ë‚´ KRW ê±°ë˜ëŒ€ê¸ˆ TOP30 ë½‘ê¸°

table-filtered.ts ìƒë‹¨ì—ì„œ ì´ë¯¸ marketStats.jsonì„ ì½ê³  ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©í•˜ê³ , ì•„ë‹ˆë¼ë©´ ì•„ë˜ ë¡œì§ ì¶”ê°€:

import marketStats from "@/data/marketStats.json"; // ì‹¤ì œ ê²½ë¡œì— ë§ê²Œ ìˆ˜ì •

type MarketStat = {
  symbol: string; // EX) "BTC"
  marketKey: string; // EX) "UPBIT:BTC:KRW"
  volume24hKrw?: number;
};

// êµ­ë‚´ KRW ê¸°ì¤€ ë§ˆì¼“ë§Œ í•„í„°
const DOMESTIC_MARKETS = ["UPBIT_KRW", "BITHUMB_KRW", "COINONE_KRW"];

function getDomesticTopSymbols(limit: number = 30): string[] {
  const stats = Object.values(marketStats as Record<string, MarketStat>);

  const domesticStats = stats.filter((s) => {
    if (!s.marketKey || !s.volume24hKrw || s.volume24hKrw <= 0) return false;
    // marketKey ì˜ˆ: "UPBIT:BTC:KRW"
    return DOMESTIC_MARKETS.some((base) => s.marketKey.startsWith(base.split("_")[0]));
  });

  const ranked = domesticStats
    .sort((a, b) => (b.volume24hKrw ?? 0) - (a.volume24hKrw ?? 0))
    .slice(0, limit);

  return ranked.map((s) => s.symbol);
}


âš ï¸ marketKey êµ¬ì¡°(ì˜ˆ: UPBIT:BTC:KRW / UPBIT_KRW:BTC)ì— ë”°ë¼ í•„í„° ì¡°ê±´ì€ ë ˆí”Œë¦¿ì´ ì‹¤ì œ êµ¬ì¡° ë³´ê³  ë§ì¶°ì„œ ì¡°ì •.

1-4. mode=fastì¼ ë•Œë§Œ TOP30ìœ¼ë¡œ í•„í„°ë§

handler ë‚´ë¶€ì—ì„œ:

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  const { domestic, foreign, mode } = req.query;

  // 1) ê¸°ì¡´ ë¡œì§ëŒ€ë¡œ premiumTable ì „ì²´ rows ìƒì„±
  const allRows = buildPremiumRows({ domestic, foreign }); 
  // buildPremiumRowsëŠ” í˜„ì¬ table-filtered.tsì—ì„œ ì´ë¯¸ ì“°ê³  ìˆëŠ” ê¸°ì¡´ í•¨ìˆ˜/ë¡œì§ì„ ê°€ì •

  // 2) FAST ëª¨ë“œì¼ ê²½ìš°: êµ­ë‚´ ê±°ë˜ëŒ€ê¸ˆ TOP30 ì‹¬ë³¼ë§Œ ë‚¨ê¸°ê¸°
  if (mode === "fast") {
    const fastSymbols = new Set(getDomesticTopSymbols(30)); // ìƒìœ„ 30ê°œ
    const fastRows = allRows.filter((row) => fastSymbols.has(row.symbol));
    return res.status(200).json({
      ...someMeta,
      rows: fastRows,
    });
  }

  // 3) ê¸°ë³¸(ì „ì²´) ëª¨ë“œ
  return res.status(200).json({
    ...someMeta,
    rows: allRows,
  });
}


FAST ì‘ë‹µ: ìƒìœ„ 30ê°œ + í˜„ì¬ í•„í„°(êµ­ë‚´/í•´ì™¸ ì¡°í•©) ì ìš©ëœ subset

SLOW ì‘ë‹µ: ê¸°ì¡´ ì „ì²´ rows ê·¸ëŒ€ë¡œ (500ê°œ ë‚´ì™¸)

2. í”„ë¡ íŠ¸ í›… â€“ useMarketsì—ì„œ FAST(1ì´ˆ) / SLOW(6ì´ˆ) ì´ì¤‘ í´ë§
2-1. íŒŒì¼ ìœ„ì¹˜

src/hooks/useMarkets.ts

2-2. SWR(or ìì²´ í›…)ë¡œ ë‘ ê°œì˜ ìš”ì²­ì„ ë™ì‹œì— ê´€ë¦¬

ì „ì œ: ì§€ê¸ˆ useMarketsì—ì„œ /api/premium/table-filteredë¥¼ í•œ ë²ˆë§Œ í˜¸ì¶œí•˜ê³  ìˆë‹¤ê³  ê°€ì •.

ì´ê±¸ FASTìš© + SLOWìš© ë‘ ë²ˆ í˜¸ì¶œë¡œ ë‚˜ëˆˆë‹¤:

import useSWR from "swr";

const fetcher = (url: string) => fetch(url).then((r) => r.json());

export function useMarkets(params: { domestic: string; foreign: string }) {
  const { domestic, foreign } = params;

  const baseQuery = `domestic=${domestic}&foreign=${foreign}`;

  // SLOW: ì „ì²´ í…Œì´ë¸”, 6ì´ˆ ê°„ê²©
  const { data: slowData, error: slowError } = useSWR(
    `/api/premium/table-filtered?${baseQuery}`,
    fetcher,
    {
      refreshInterval: 6000, // ğŸ”µ SLOW = 6ì´ˆ
      revalidateOnFocus: true,
    }
  );

  // FAST: TOP30ë§Œ, 1ì´ˆ ê°„ê²©
  const { data: fastData } = useSWR(
    `/api/premium/table-filtered?${baseQuery}&mode=fast`,
    fetcher,
    {
      refreshInterval: 1000, // ğŸ”´ FAST = 1ì´ˆ
      revalidateOnFocus: true,
    }
  );

  // ê¸°ë³¸ rows = SLOW ì‘ë‹µ (ì „ì²´)
  const baseRows = slowData?.rows ?? [];

  // FAST ì‹¬ë³¼ ì§‘í•©
  const fastSymbolSet = new Set(
    (fastData?.rows ?? []).map((row: any) => row.symbol)
  );

  // FAST rows ë§µìœ¼ë¡œ ë§Œë“¤ì–´ì„œ baseRowsì— ë®ì–´ì“°ê¸°
  const fastMap = new Map(
    (fastData?.rows ?? []).map((row: any) => [row.symbol, row])
  );

  const mergedRows = baseRows.map((row: any) => {
    const fastRow = fastMap.get(row.symbol);
    return fastRow ?? row;
  });

  return {
    rows: mergedRows,
    isLoading: !slowData && !slowError,
    isError: !!slowError,
    fastSymbolSet,
  };
}


SLOW(ì „ì²´): 6ì´ˆì— í•œ ë²ˆ ì „ì²´ í…Œì´ë¸” ê°€ì ¸ì˜¤ê¸°

FAST(TOP30): 1ì´ˆì— í•œ ë²ˆ TOP30ë§Œ ê°€ì ¸ì™€ì„œ
â†’ mergedRowsì—ì„œ í•´ë‹¹ ì‹¬ë³¼ë§Œ ë¹ ë¥´ê²Œ ë®ì–´ì“°ê¸°

ì´ êµ¬ì¡°ë¡œ íŠ¸ë˜í”½ì´ ì „ì²´ 1ì´ˆ ëŒ€ë¹„ ëŒ€ëµ 4ë°° ì´ìƒ ì ˆê°.

3. PremiumTableì—ì„œ FAST í–‰ í‘œì‹œ (ê¹œë¹¡ì„ / ìŠ¤íƒ€ì¼ ë¶„ë¦¬)
3-1. íŒŒì¼ ìœ„ì¹˜

src/components/PremiumTable.tsx

3-2. useMarketsì—ì„œ ì˜¨ fastSymbolSetì„ ë°›ì•„ì„œ í–‰ë³„ë¡œ isFastRow í”Œë˜ê·¸ ì¶”ê°€
import { useMarkets } from "@/hooks/useMarkets";

type PremiumTableProps = {
  domestic: string;
  foreign: string;
  // ...
};

const PremiumTable: React.FC<PremiumTableProps> = ({ domestic, foreign }) => {
  const { rows, isLoading, isError, fastSymbolSet } = useMarkets({
    domestic,
    foreign,
  });

  if (isLoading) return <div>Loading...</div>;
  if (isError) return <div>Error...</div>;

  return (
    <table className="...">
      <tbody>
        {rows.map((row) => {
          const isFastRow = fastSymbolSet.has(row.symbol);

          return (
            <PremiumTableRow
              key={row.id ?? row.symbol}
              row={row}
              isFastRow={isFastRow}
            />
          );
        })}
      </tbody>
    </table>
  );
};

export default PremiumTable;

3-3. PremiumTableRow / TwoLinePriceCellì—ì„œ ìŠ¤íƒ€ì¼ ë¶„ê¸°

FAST í–‰:

ê°€ê²©/ê¹€í”„/ê±°ë˜ì•¡ ë³€í™” â†’ ê¸°ì¡´ì²˜ëŸ¼ ê°•í•œ ê¹œë¹¡ì„ í´ë˜ìŠ¤

ì• ë‹ˆë©”ì´ì…˜ duration ì§§ê²Œ

SLOW í–‰:

ê¹œë¹¡ì„ ì—†ì• ê±°ë‚˜, opacity ì‚´ì§ë§Œ ì¤˜ì„œ ì€ì€í•˜ê²Œ

type PremiumTableRowProps = {
  row: any;
  isFastRow: boolean;
};

const PremiumTableRow: React.FC<PremiumTableRowProps> = ({ row, isFastRow }) => {
  return (
    <tr className={isFastRow ? "fast-row" : "slow-row"}>
      {/* ì˜ˆì‹œ */}
      <TwoLinePriceCell
        topValue={row.domesticPrice}
        bottomValue={row.foreignPrice}
        isFastRow={isFastRow}
        // ...
      />
    </tr>
  );
};


TwoLinePriceCell.tsx ì˜ˆ:

type TwoLinePriceCellProps = {
  topValue: number;
  bottomValue: number;
  isFastRow?: boolean;
  // ...
};

const TwoLinePriceCell: React.FC<TwoLinePriceCellProps> = ({
  topValue,
  bottomValue,
  isFastRow,
}) => {
  const blinkClass = isFastRow ? "animate-blink-strong" : "animate-blink-weak";

  return (
    <div className="flex flex-col">
      <span className={`text-right ${blinkClass}`}>
        {formatKrwDomestic(topValue)}
      </span>
      <span className={`text-right text-xs opacity-80 ${blinkClass}`}>
        {formatKrwForeign(bottomValue)}
      </span>
    </div>
  );
};


CSS / Tailwind ìª½ì€ ë ˆí”Œë¦¿ì´ ê¸°ì¡´ ê¹œë¹¡ì„ í´ë˜ìŠ¤ ì¬ì‚¬ìš©í•´ì„œ fast/slow ê°•ë„ë§Œ ë‹¤ë¥´ê²Œ ì„¤ì •.

4. ì¶”ê°€ ìµœì í™”(ë‚˜ì¤‘ì—)

ì§€ê¸ˆì€ V1 ëª©í‘œ: FAST 1ì´ˆ / SLOW 6ì´ˆë§Œ í™•ì‹¤íˆ êµ¬í˜„.

ì¶”ê°€ë¡œ ë‚˜ì¤‘ì— ë ˆí”Œë¦¿í•œí…Œ ë§¡ê¸¸ TODO:

íƒ­ ë¹„í™œì„±í™” ì‹œ í´ë§ ê°„ê²© ëŠ˜ë¦¬ê¸°

document.hidden ê°ì§€

ìˆ¨ê¹€ì´ë©´: FAST 1ì´ˆ â†’ 3ì´ˆ / SLOW 6ì´ˆ â†’ 15ì´ˆ

ìŠ¤í¬ë¡¤ In-View ì•„ë‹ ë•Œ SLOW ì¼ì‹œ ì •ì§€

react-intersection-observerë¡œ í…Œì´ë¸” viewport ì•ˆì¼ ë•Œë§Œ SLOW í´ë§

WebSocket ì „í™˜(FAST ì „ìš©)

/api/premium/table-fast-stream ê°™ì€ WSë¡œ TOP30ë§Œ push

SLOWëŠ” REST 6ì´ˆ ìœ ì§€

5. í•œ ì¤„ ê²°ë¡  (ë ˆí”Œë¦¿ìš© ìš”ì•½)

ë°±ì—”ë“œëŠ” ê·¸ëŒ€ë¡œ ì „ì²´ ì½”ì¸ 3ì´ˆ ìˆ˜ì§‘ ìœ ì§€.
/api/premium/table-filteredì— mode=fast ì¶”ê°€í•´ì„œ êµ­ë‚´ KRW ê±°ë˜ëŒ€ê¸ˆ TOP30ë§Œ ì‘ë‹µí•˜ëŠ” FAST ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë§Œë“¤ê³ ,
í”„ë¡ íŠ¸ useMarketsì—ì„œ SLOW(ì „ì²´, 6ì´ˆ) + FAST(TOP30, 1ì´ˆ) ë‘ ë²ˆ í´ë§í•´ì„œ FAST rowsë§Œ ë®ì–´ì“°ëŠ” êµ¬ì¡°ë¡œ êµ¬í˜„.
fastSymbolSetìœ¼ë¡œ FAST í–‰ì€ ê°•í•œ ê¹œë¹¡ì„, ë‚˜ë¨¸ì§€ëŠ” ëŠë¦° SLOW ëŠë‚Œìœ¼ë¡œ ìŠ¤íƒ€ì¼ ë¶„ë¦¬.