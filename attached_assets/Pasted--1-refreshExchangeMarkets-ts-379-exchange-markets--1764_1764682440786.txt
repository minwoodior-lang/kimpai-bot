[1] 지금 상태 요약 + 당장 막힌 핵심 버그

- refreshExchangeMarkets.ts: 실행 로그로는 "379개 마켓이 exchange_markets에 저장됨" 이라고 나오지만,
- 실제 Supabase에서 확인하면 exchange_markets에는 0개입니다.

즉, 크롤링/파싱/조인/프론트는 다 준비됐는데,
정작 DB에 저장이 하나도 안 되고 있습니다.

원인 후보는 다음과 같습니다:
- scripts/refreshExchangeMarkets.ts 의 upsertMarkets() 함수에서
  supabase.from("exchange_markets").upsert(...) 호출이 실패해도
  markets.length 를 그대로 리턴해서 "성공"처럼 보이게 만드는 구조입니다.
- onConflict: "exchange,market_code" 옵션이 실제 Supabase 스키마/인덱스와 맞지 않아서
  조용히 실패하고 있을 가능성도 큽니다.

=== 요청 1: upsertMarkets()를 먼저 확실하게 고쳐서, 실제로 DB에 저장되게 해주세요. ===

KimpAI는 10분마다 전체 마켓을 다시 긁어오는 구조라,
exchange_markets는 풀 리프레시(delete → insert) 방식으로 운영해도 괜찮습니다.

복잡한 upsert 대신, 아래처럼 단순 delete + insert 방식으로 바꿔주시는 게 좋겠습니다:

1) 기존 데이터 전체 삭제
2) 새로 크롤링한 markets 배열을 한 번에 insert
3) insert된 row 수를 그대로 return

예시 (개념):

async function upsertMarkets(markets: ExchangeMarketRow[]): Promise<number> {
  if (markets.length === 0) return 0;

  // 1. 기존 데이터 전체 삭제
  const { error: delError } = await supabase
    .from("exchange_markets" as any)
    .delete()
    .neq("id", 0);

  if (delError) {
    console.error("[DB Delete Error]:", delError.message);
    throw delError;
  }

  // 2. 새 데이터 insert
  const { data, error } = await supabase
    .from("exchange_markets" as any)
    .insert(markets as any);

  if (error) {
    console.error("[DB Insert Error]:", error.message);
    throw error;
  }

  return (data as any[])?.length || 0;
}

그리고:

const savedCount = await upsertMarkets(allMarkets);
console.log(`[Market Refresh] ${savedCount}개 마켓 저장 완료`);

- 이렇게 해서 savedCount가 실제 insert 된 row 수가 되도록 해 주세요.
- 만약 savedCount가 0이면 로그에 에러로 찍히도록 해서, "성공 메시지 + DB 0개" 상황이 다시는 안 나오게 해주시면 좋겠습니다.

지금까지 구축해주신 인프라/조인/프론트는 그대로 두고,
이 upsert 부분만 확실하게 저장되도록 고쳐주시면, 전체 파이프라인이 실제로 동작하게 됩니다.


[2] [중요 스펙 재정의] 한글명 + 아이콘 = "거래소 마켓 화면"이 진짜 정답

지금까지 인프라/조인 구조는 잘 잡아주셔서 감사합니다.
다만 심볼/이름/아이콘의 "진짜 원본"을 무엇으로 할지를 다시 명확히 하고 싶습니다.

✅ 최종 목표:
업비트 / 빗썸 / 코인원 각 거래소의 "마켓 리스트 화면"에 보이는
한글명 + 아이콘을 그대로 KimpAI에서 재현하는 것.

(공통 아이콘 세트나 임의 매핑이 "정답"이 아니라,
각 거래소 UI가 정답입니다.)

그래서 refreshExchangeMarkets / exchange_markets 쪽 스펙을
아래 기준으로 수정/고정해 주셨으면 합니다.


1️⃣ exchange_markets에 들어가는 값 스펙 확정

exchange_markets 테이블은 앞으로 "거래소 마켓 화면 스냅샷" 역할을 합니다.

각 row는 한 마켓(예: 업비트 KRW-BTC)에 대해 아래처럼 채워져야 합니다:

- exchange
  - "upbit" | "bithumb" | "coinone"

- market_code
  - 업비트: KRW-BTC
  - 빗썸: BTC_KRW
  - 코인원: 해당 거래소 실제 마켓 코드

- base_symbol / quote_symbol
  - 실제 거래 심볼 기준 (BTC / KRW, 등)

- name_ko
  - 해당 거래소 마켓 화면에 표시되는 한글 이름 그대로
  - 예) "비트코인", "리플", "폴리곤(매틱)" 등

- name_en
  - 표시되는 경우에만, 마켓 리스트/상세에서 쓰는 영어 이름 그대로

- icon_url
  - 그 거래소 마켓 화면에서 <img src="..."> 로 사용 중인 아이콘 URL 그대로

요약:
exchange_markets는 "코인 정보"가 아니라
"거래소 + 마켓별 UI 데이터"라고 생각해주시면 됩니다.


2️⃣ refreshExchangeMarkets 구현 기준 (핵심)

[업비트 (UPBIT)]

- 이름(name_ko, name_en)
  - 지금처럼 업비트 API의 korean_name, english_name을 쓰는 건 괜찮습니다.

- 아이콘(icon_url)
  - 공통 아이콘 세트나 CoinGecko 기반이 아니라,
    업비트 실제 웹 마켓 리스트/코인 목록에서 사용하는 아이콘 URL을 기준으로 맞춰주시면 좋겠습니다.

  - 방법 예시:
    - 업비트 마켓/코인 리스트 페이지(정적 JS/JSON/HTML)에서
      코인별 <img src="...">를 파싱해서 symbol과 매칭
    - 그 URL을 exchange_markets.icon_url에 저장

[빗썸 / 코인원 (BITHUMB / COINONE)]

여기가 이번에 제일 중요한 부분입니다.

현재 코드에 BITHUMB_COINS 같은 매핑이 있는 걸로 보이는데,
이 매핑은 "임시 fallback" 정도만 쓰고,
최종 기준은 아래처럼 "웹 UI 크롤링"으로 바꿔 달라는 요청입니다.

- 이름(name_ko, name_en)
  - 빗썸/코인원 마켓 리스트 페이지(또는 코인 목록 페이지)에서
    실제 화면에 보이는 코인명 텍스트를 그대로 파싱해서 name_ko에 넣어 주세요.
  - 영어 이름이 따로 표시되면 그걸 name_en에 넣고, 없으면 null.

- 아이콘(icon_url)
  - 빗썸/코인원에서 각 코인 앞에 붙는 <img src="...">
    → 이 URL을 그대로 icon_url에 저장해 주세요.
  - 앞으로 아이콘 정답은 "거래소가 쓰는 아이콘"입니다.
    (공통 아이콘 세트/임의 PNG는 fallback 정도만 허용)

- 기존 하드코딩 매핑(BITHUMB_COINS 등)
  - 있다면:
    - 1차 기준: 크롤링 성공한 값(name_ko/icon_url)
    - 2차 fallback: 매핑에 있는 값
  - 즉, 최종 소스 오브 트루스는 "웹 크롤링 데이터"가 되어야 합니다.


3️⃣ 리프레시 시 업데이트 정책

refreshExchangeMarkets 실행 시:

1. 각 거래소 웹/정적 리소스 기준으로
   - 마켓 리스트를 긁고
   - 한글명/영문명/아이콘 URL을 파싱

2. exchange_markets에 upsert:
   - 새 마켓 → insert
   - 기존 마켓 → name_ko / name_en / icon_url 변경 시 업데이트

이렇게 하면:

- 거래소에서 아이콘/이름 바꾸면
  → KimpAI도 다음 refresh 때 자동 동일하게 변경되는 구조가 됩니다.


4️⃣ 프론트/검수 기준

제가 확인할 때는 이렇게 체크할 예정입니다:

- 업비트/빗썸/코인원 각각에 대해
  - 랜덤으로 코인 몇 개 골라서
  - 거래소 마켓 리스트 화면과
    KimpAI 화면의

    - 한글 이름
    - 아이콘

  이 눈으로 봐도 똑같은지 비교할 예정입니다.

아이콘 파일 자체가 완전히 동일할 필요까지는 없지만,
최소한 같은 원본 URL(거래소 CDN) 또는
거래소와 동일하게 보이는 이미지를 사용하는지를 기준으로 보겠습니다.


5️⃣ 요약

- 인프라/조인/스케줄러/프론트 구조는 지금 방향이 좋습니다.
- 지금 당장 막힌 부분은 exchange_markets에 실제로 저장이 안 되는 upsert 쪽이니,
  이 부분을 먼저 delete+insert 또는 제대로 된 upsert로 고쳐주시고,
- 그 위에서 한글명+아이콘의 정답을 "각 거래소 마켓 화면"으로 고정하는 것이 최종 목표입니다.

한 번에 정리해서 부탁드립니다.
