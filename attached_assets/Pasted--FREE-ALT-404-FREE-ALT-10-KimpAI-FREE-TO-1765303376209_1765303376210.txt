[작업 요청] FREE ALT 스캔 404 오류 및 스케줄러 비활성 문제 해결

🎯 목표

FREE ALT 스캔이 10분마다 정상적으로 동작해서
KimpAI FREE 채널에 TOP50 알트 시그널이 계속 올라오게 만들 것.

데이터 소스는 반드시 https://kimpai.io 기준 API를 사용.

/api/bot/alts 404 오류를 제거하고, 스케줄러가 항상 등록되도록 수정.

1) /api/bot/alts 404 문제 먼저 해결

현재 텔레그램 봇 로그에서:

❌ ALT API 호출 실패: Request failed with status code 404


가 발생했습니다.

이건 API_BASE_URL + /api/bot/alts?limit=50 호출 시
kimpai.io 쪽 Next.js API 라우트가 404를 리턴중이라는 의미입니다.

해야 할 작업

API 라우트 파일 위치 확인

프로젝트 안에서 아래 파일이 실제로 존재하는지 확인해주세요:

src/pages/api/bot/alts.ts
또는

src/pages/api/bot/alts/index.ts

만약 파일이 없다면, 새로 만들어주세요:

// src/pages/api/bot/alts.ts
import type { NextApiRequest, NextApiResponse } from "next";
import { getTopAltsSignals } from "@/lib/bot/altSignals"; // 이미 구현된 유틸 사용 또는 새로 구현

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  try {
    const limit = parseInt((req.query.limit as string) || "50", 10);
    const data = await getTopAltsSignals({ limit }); // premiumTable.json + marketStats.json 기반

    return res.status(200).json({ success: true, data });
  } catch (err: any) {
    console.error("[API /bot/alts] error:", err?.message || err);
    return res.status(500).json({ success: false, error: "alts_api_error" });
  }
}


로컬에서 먼저 테스트

Dev 서버 실행 후:

npm run dev


브라우저에서:

http://localhost:3000/api/bot/alts

http://localhost:3000/api/bot/alts?limit=50

호출했을 때 JSON 응답이 떨어지는지 확인해주세요.

그 다음 배포본(kimpai.io) 에도 라우트가 올라갔는지 확인:

https://kimpai.io/api/bot/alts

https://kimpai.io/api/bot/alts?limit=50

여기서 200 OK + JSON 나오게 해주세요.

2) FREE ALT 스케줄러가 항상 등록되도록 강제

지금 npm run bot:dev 실행 시 로그는 이렇게만 나옵니다:

📅 스케줄러 등록 중...
⏰ PRO 관심종목 스캔 트리거 (5분마다)
[PRO Scan] 사용자 관심종목 스캔 시작...
[PRO Scan] PRO 사용자 없음


예전에는:

⏰ FREE ALT 스캔 트리거 (10분마다)
[FREE Scan] TOP50 알트 스캔 시작...
...


로그가 찍혔는데, 지금은 FREE ALT 스케줄러가 아예 안 찍히고 있습니다.

해야 할 작업

src/bot/index.js 또는 스케줄러 등록 파일에서

registerFreeAltScan(bot, channelId);
registerFreeBtcScan(bot, channelId);
registerProWatchlistScan(bot);


이런 식으로 FREE ALT 스케줄 등록이
조건문 없이 항상 호출되도록 수정해주세요.

혹시 아래 같은 조건이 있다면 제거해주세요:

if (process.env.NODE_ENV === "production") {
  // FREE ALT 스캔 등록
}


또는

if (API_BASE_URL && TELEGRAM_CHANNEL_ID) {
  // ...
}


freeAltScan 내부에서 첫 호출 실패(404) 때문에
타이머를 멈추는 로직이 있다면,
그 부분도 “로그만 찍고 계속 시도”하도록 변경해주세요.

예시:

try {
  const alts = await getAltSignals();
  // ...
} catch (err) {
  console.error("❌ ALT API 호출 실패:", err.message);
  return; // ❌ 여기서 스케줄러 중지 or throw 금지
}


→ 여기서는 throw 하지 말고, 다음 주기에서 다시 시도할 수 있도록 해주세요.

3) getAltSignals() 가 올바른 URL을 보는지 확인

src/bot/utils/marketData.js (이름은 실제 파일명 기준으로):

const baseUrl = process.env.API_BASE_URL || "http://localhost:3000";

export async function getAltSignals() {
  const url = `${baseUrl}/api/bot/alts?limit=50`;
  // ...
}


이런 구조라면:

dev/테스트: .env 에는 API_BASE_URL=http://localhost:3000

실 서비스: Replit Secrets에 API_BASE_URL=https://kimpai.io

로 맞춰주시고, 실제로 저 URL에서 200이 떨어지는지 꼭 확인해주세요.

4) 수정 후 내가 확인할 포인트

작업 끝나면, 제가 아래를 체크할 수 있도록 해주세요:

npm run bot:dev 실행 시 콘솔 로그:

📅 스케줄러 등록 중...
⏰ FREE ALT 스캔 트리거 (10분마다)
⏰ FREE BTC 스캔 트리거 (30분마다)
⏰ PRO 관심종목 스캔 트리거 (5분마다)


10분 이내에:

FREE 채널에 TOP50 중 3개 알트 시그널 올라오는지

콘솔에:

[FREE Scan] TOP50 알트 스캔 시작...
✅ [FREE Scan] XXX 메시지 전송 완료


이런 로그가 뜨는지

브라우저에서:

https://kimpai.io/api/bot/alts?limit=50 JSON 확인